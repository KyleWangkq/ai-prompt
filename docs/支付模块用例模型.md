# 支付模块用例模型文档

## 文档信息
| 项目 | 内容 |
|------|------|
| **文档名称** | 支付模块用例模型文档 |
| **项目名称** | 企业间特种设备定制交易系统 - 支付模块 |
| **文档版本** | v1.0 |
| **创建日期** | 2025年1月 |
| **基准文档** | 支付模块需求设计.md v1.4 |
| **文档状态** | 正式版 |

## 目录
- [1. 参与者识别](#1-参与者识别)
- [2. 用例图](#2-用例图)
- [3. 用例描述](#3-用例描述)

## 1. 参与者识别

根据支付模块需求设计文档，识别出以下参与者：

### 1.1 主要参与者（Primary Actors）

| 参与者名称 | 英文名称 | 描述 | 职责 |
|----------|----------|------|------|
| **经销商** | Reseller | B2B交易中的企业买方，支付发起方 | 发起支付、选择支付单、执行支付操作、查询支付状态 |
| **财务人员** | Finance Staff | 企业财务部门工作人员 | 查询支付流水、执行对账、生成财务报表、监控支付状态 |
| **系统管理员** | System Administrator | 支付系统管理人员 | 监控系统运行、处理异常、配置系统参数 |

### 1.2 次要参与者（Secondary Actors）

| 参与者名称 | 英文名称 | 描述 | 职责 |
|----------|----------|------|------|
| **订单系统** | Order System | 上游业务系统，管理订单生命周期 | 创建支付单、接收支付结果通知、发起退款指令 |
| **支付渠道** | Payment Channel | 第三方支付服务提供商或内部支付模块 | 处理支付请求、返回支付结果、发送支付回调 |
| **信用管理系统** | Credit Management System | 管理企业信用额度和还款 | 创建信用还款支付单、接收还款结果通知 |
| **财务系统** | Finance System | 企业财务核算系统 | 接收支付流水数据、进行财务记账 |

## 2. 用例图

### 2.1 支付单管理模块

```
                    ┌────────────────┐
                    │   订单系统     │
                    └───────┬────────┘
                            │
                            │ 创建支付单
                            │
                            ▼
                    ┌───────────────┐
                    │ 接收支付单创建│
                    │   请求        │◄──────────┐
                    └───────────────┘           │
                            │                   │
                            │                   │
                            ▼                   │
                    ┌───────────────┐           │
                    │ 验证支付单信息│           │
                    └───────────────┘           │
                            │                   │
                            │                   │
                            ▼                   │
                    ┌───────────────┐           │
            ┌───────┤ 生成支付单号  │           │
            │       └───────────────┘           │
            │                                   │
    ┌───────▼────────┐                         │
    │   经销商       ├─────────────────────────┘
    │               │       查询支付单
    └───────┬────────┘
            │
            │ 查询支付单状态
            │
            ▼
    ┌───────────────┐
    │ 查询支付单信息│
    └───────────────┘
```

### 2.2 支付执行模块

```
    ┌───────────────┐
    │   经销商      │
    └───────┬───────┘
            │
            │ 选择支付单
            │
            ▼
    ┌───────────────┐
    │ 筛选支付单    │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐              ┌───────────────┐
    │ 选择支付渠道  ├──────────────►│  支付渠道     │
    └───────┬───────┘              └───────┬───────┘
            │                              │
            │                              │ 返回支付结果
            ▼                              │
    ┌───────────────┐                     │
    │ 分配支付金额  │                     │
    └───────┬───────┘                     │
            │                              │
            │                              │
            ▼                              ▼
    ┌───────────────┐              ┌───────────────┐
    │ 执行支付操作  ├──────────────►│ 处理支付回调  │
    └───────┬───────┘              └───────┬───────┘
            │                              │
            │                              │
            ▼                              ▼
    ┌───────────────┐              ┌───────────────┐
    │ 更新支付状态  │              │ 通知订单系统  │
    └───────────────┘              └───────────────┘
```

### 2.3 支付查询模块

```
    ┌───────────────┐
    │   经销商      │
    └───────┬───────┘
            │
            │ 查询支付结果
            │
            ▼
    ┌───────────────┐
    │ 设置查询条件  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 查询支付单    │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 查询支付流水  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 展示查询结果  │
    └───────────────┘


    ┌───────────────┐
    │  财务人员     │
    └───────┬───────┘
            │
            │ 生成支付报表
            │
            ▼
    ┌───────────────┐
    │ 统计支付数据  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 导出报表数据  │
    └───────────────┘
```

### 2.4 退款管理模块

```
    ┌───────────────┐
    │  订单系统     │
    └───────┬───────┘
            │
            │ 发起退款指令
            │
            ▼
    ┌───────────────┐
    │ 接收退款请求  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 选择支付流水  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐              ┌───────────────┐
    │ 执行退款操作  ├──────────────►│  支付渠道     │
    └───────┬───────┘              └───────┬───────┘
            │                              │
            │                              │ 返回退款结果
            ▼                              │
    ┌───────────────┐                     │
    │ 更新退款金额  │◄────────────────────┘
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 通知订单系统  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 通知财务系统  │
    └───────────────┘
```

### 2.5 对账管理模块

```
    ┌───────────────┐
    │  财务人员     │
    └───────┬───────┘
            │
            │ 执行对账
            │
            ▼
    ┌───────────────┐              ┌───────────────┐
    │ 获取支付流水  ├──────────────►│  支付渠道     │
    └───────┬───────┘              └───────────────┘
            │                      获取渠道对账单
            │
            ▼
    ┌───────────────┐
    │ 核对交易记录  │
    └───────┬───────┘
            │
            │
            ├───────► 一致 ──────► 生成对账报告
            │
            │
            └───────► 差异 ──────► 处理对账差异
```

### 2.6 信用还款模块

```
    ┌───────────────┐
    │ 信用管理系统  │
    └───────┬───────┘
            │
            │ 创建还款支付单
            │
            ▼
    ┌───────────────┐
    │ 生成还款支付单│
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │   经销商      ├────► 执行还款支付（按统一支付流程）
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 通知信用系统  │
    └───────────────┘
```

## 3. 用例描述

### 用例UC-PM-001: 接收支付单创建请求

**1）用例编号**: UC-PM-001

**2）用例名称**: 接收支付单创建请求

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：订单系统（发起）
- 次要参与者：无

**5）前置条件**: 
- 订单系统已生成订单
- 订单需要创建对应的支付单

**6）成功流**:
1. 订单系统发送支付单创建请求，包含订单号、经销商ID、支付金额、支付类型等信息
2. 系统接收创建请求
3. 系统验证请求数据的完整性和合法性
4. 系统检查支付单唯一性，避免重复创建
5. 系统验证支付金额的合理性
6. 系统生成唯一的支付单流水号
7. 系统初始化支付单状态为"未支付"
8. 系统将支付单信息持久化到数据库
9. 系统向订单系统返回支付单创建成功结果，包含支付单号

**7）分支流**:
- 无

**8）替代流**:
- 3.1 如果请求数据不完整或格式错误，系统返回验证失败信息，流程结束
- 4.1 如果检测到重复支付单，系统返回已存在的支付单信息，流程结束
- 5.1 如果支付金额不合理（如为负数或超出限制），系统返回金额验证失败信息，流程结束

**9）后置条件**: 
- 系统成功创建支付单记录
- 支付单状态为"未支付"
- 订单系统获得支付单号

---

### 用例UC-PM-002: 筛选支付单

**1）用例编号**: UC-PM-002

**2）用例名称**: 筛选支付单

**3）用例类型**: 查询报表

**4）参与者**: 
- 主要参与者：经销商
- 次要参与者：无

**5）前置条件**: 
- 经销商已登录系统
- 系统中存在该经销商的支付单

**6）成功流**:
1. 经销商进入支付单筛选页面
2. 系统展示筛选条件选项（支付状态、支付类型、订单范围、金额范围、时间范围）
3. 经销商设置筛选条件
4. 经销商提交筛选请求
5. 系统根据筛选条件查询支付单
6. 系统展示符合条件的支付单列表
7. 系统显示每个支付单的详细信息（支付金额、已支付金额、待支付金额、状态、截止时间等）

**7）分支流**:
- 3.1 经销商可以选择不设置任何筛选条件，查看所有支付单
- 6.1 经销商可以对筛选结果进行排序（按金额、时间等）
- 7.1 经销商可以选择单个或多个支付单进行后续操作

**8）替代流**:
- 6.1 如果没有符合条件的支付单，系统显示"无符合条件的支付单"提示，流程结束

**9）后置条件**: 
- 经销商获得符合条件的支付单列表
- 支付单信息可供查看和选择

---

### 用例UC-PM-003: 执行支付操作

**1）用例编号**: UC-PM-003

**2）用例名称**: 执行支付操作

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：经销商
- 次要参与者：支付渠道

**5）前置条件**: 
- 经销商已登录系统
- 经销商已选择至少一个待支付的支付单
- 支付单状态允许支付（未支付或部分支付）

**6）成功流**:
1. 经销商选择一个或多个支付单
2. 系统验证所选支付单属于同一经销商
3. 系统检查支付单状态是否允许支付
4. 经销商选择支付渠道
5. 系统显示每个支付单的待支付金额
6. 经销商为每个支付单分配本次支付金额
7. 系统计算总支付金额（所有参与支付单的金额之和）
8. 系统校验每个支付单的支付金额不超过其待支付金额
9. 系统调用支付渠道创建支付请求
10. 支付渠道返回支付渠道交易号
11. 系统为每个参与支付的支付单创建独立的支付流水记录
12. 系统更新流水状态为"支付中"
13. 系统更新所有参与支付的支付单状态为"支付中"
14. 系统向经销商展示支付操作结果

**7）分支流**:
- 1.1 经销商可以选择单个支付单支付（作为多支付单的特例）
- 4.1 经销商可以查看各支付渠道的特点和限制
- 6.1 经销商可以选择全额支付或部分支付
- 6.2 经销商可以调整不同支付单的金额分配

**8）替代流**:
- 2.1 如果所选支付单不属于同一经销商，系统提示验证失败，返回步骤1
- 3.1 如果存在不允许支付的支付单，系统提示状态错误，返回步骤1
- 8.1 如果支付金额超过待支付金额，系统提示金额错误，返回步骤6
- 9.1 如果支付渠道调用失败，系统记录失败原因，提示用户重试或更换渠道，流程结束

**9）后置条件**: 
- 支付请求已提交到支付渠道
- 支付流水记录已创建
- 支付单状态更新为"支付中"
- 等待支付渠道回调确认

---

### 用例UC-PM-004: 处理支付回调

**1）用例编号**: UC-PM-004

**2）用例名称**: 处理支付回调

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：支付渠道（发起）
- 次要参与者：订单系统

**5）前置条件**: 
- 支付请求已发送到支付渠道
- 支付渠道已处理支付请求

**6）成功流**:
1. 支付渠道发送支付回调通知
2. 系统接收回调数据
3. 系统校验回调签名和数据完整性
4. 系统根据渠道交易号查找对应的支付流水记录
5. 系统获取支付流水关联的支付单
6. 系统根据回调结果更新支付流水状态（成功/失败）
7. 系统更新支付单的已支付金额
8. 系统重新计算支付单的待支付金额和实际收款金额
9. 系统根据待支付金额是否为0更新支付单状态（部分支付/已支付）
10. 系统保存支付单和流水变更
11. 系统向支付渠道返回回调处理成功确认
12. 系统向订单系统发送支付结果通知

**7）分支流**:
- 4.1 对于合并支付，系统同步更新所有相关支付单的状态
- 6.1 如果支付失败，系统更新流水状态为"失败"，支付单状态恢复为之前状态

**8）替代流**:
- 3.1 如果签名验证失败，系统记录安全日志，拒绝处理回调，流程结束
- 4.1 如果找不到对应的支付流水，系统记录异常日志，返回"流水不存在"响应，流程结束
- 12.1 如果通知订单系统失败，系统将通知加入重试队列，后续自动重试

**9）后置条件**: 
- 支付流水状态已更新
- 支付单金额和状态已更新
- 订单系统已收到支付结果通知

---

### 用例UC-PM-005: 查询支付单信息

**1）用例编号**: UC-PM-005

**2）用例名称**: 查询支付单信息

**3）用例类型**: 查询报表

**4）参与者**: 
- 主要参与者：经销商
- 次要参与者：无

**5）前置条件**: 
- 经销商已登录系统

**6）成功流**:
1. 经销商进入支付单查询页面
2. 经销商选择查询方式（支付单号、订单号、交易号、经销商ID）
3. 经销商输入查询条件
4. 经销商提交查询请求
5. 系统根据查询条件检索支付单
6. 系统展示支付单基础信息（总金额、已支付金额、已退款金额、实际收款金额、状态、时间等）
7. 系统展示支付进度（已支付/总金额）
8. 系统展示支付流水历史记录
9. 系统展示关联订单和经销商信息

**7）分支流**:
- 2.1 经销商可以使用条件筛选（支付状态、支付类型、时间范围、金额范围、支付渠道）
- 6.1 经销商可以查看支付单详细信息
- 8.1 经销商可以查看每条支付流水的详细信息（渠道、金额、时间、状态）
- 8.2 对于合并支付，系统展示渠道交易号关联的所有支付流水
- 9.1 经销商可以导出查询结果

**8）替代流**:
- 5.1 如果查询条件无效，系统提示输入错误，返回步骤3
- 5.2 如果未找到符合条件的支付单，系统显示"未找到相关支付单"提示，流程结束

**9）后置条件**: 
- 经销商获得支付单详细信息
- 经销商了解支付进度和历史

---

### 用例UC-PM-006: 接收退款执行指令

**1）用例编号**: UC-PM-006

**2）用例名称**: 接收退款执行指令

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：订单系统（发起）
- 次要参与者：支付渠道

**5）前置条件**: 
- 订单系统已完成退款审批
- 原支付单存在且已支付
- 退款金额不超过已支付金额

**6）成功流**:
1. 订单系统发送退款执行指令，包含退款单号、支付单号、退款金额、退款原因等
2. 系统接收退款指令
3. 系统验证退款指令的完整性和合法性
4. 系统根据支付单号查找原支付单
5. 系统验证支付单状态是否允许退款
6. 系统验证退款金额是否超过可退款金额
7. 系统查询原支付单的成功支付流水记录
8. 系统按支付时间倒序排列支付流水
9. 系统根据配置的策略选择退款流水（最新流水退款/指定流水退款/多流水分摊）
10. 系统调用对应支付渠道的退款接口
11. 支付渠道返回退款处理结果
12. 系统创建退款流水记录（流水类型为"退款"，金额为负数）
13. 系统更新支付单的已退款金额
14. 系统重新计算实际收款金额（已支付金额 - 已退款金额）
15. 系统根据退款比例更新支付单退款状态（部分退款/全额退款）
16. 系统保存退款流水和支付单变更
17. 系统向订单系统发送退款结果通知
18. 系统向财务系统同步退款流水信息

**7）分支流**:
- 9.1 如果选择指定流水退款，系统使用指定的支付流水进行退款
- 9.2 如果选择多流水分摊退款，系统按支付金额比例分摊到多个流水

**8）替代流**:
- 3.1 如果退款指令数据不完整或格式错误，系统返回验证失败信息，流程结束
- 4.1 如果未找到原支付单，系统返回"支付单不存在"错误，流程结束
- 5.1 如果支付单状态不允许退款，系统返回状态错误信息，流程结束
- 6.1 如果退款金额超过可退款金额，系统返回金额错误信息，流程结束
- 10.1 如果支付渠道退款失败，系统记录失败原因，支持重试机制，返回退款失败结果
- 17.1 如果通知订单系统失败，系统将通知加入重试队列
- 18.1 如果通知财务系统失败，系统将通知加入重试队列

**9）后置条件**: 
- 退款流水记录已创建
- 支付单退款金额已更新
- 支付单退款状态已更新
- 订单系统和财务系统已收到退款结果通知

---

### 用例UC-PM-007: 执行支付对账

**1）用例编号**: UC-PM-007

**2）用例名称**: 执行支付对账

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：财务人员
- 次要参与者：支付渠道

**5）前置条件**: 
- 财务人员已登录系统
- 已到达对账时间（通常为每日定时）

**6）成功流**:
1. 财务人员启动对账任务
2. 系统选择对账时间范围
3. 系统获取指定时间范围内的支付流水数据
4. 系统从各支付渠道获取对账单数据
5. 系统对比本地支付流水与渠道对账单
6. 系统核对每笔交易的一致性（交易号、金额、状态）
7. 系统统计对账结果（成功笔数、失败笔数、差异笔数）
8. 系统生成对账报告
9. 系统保存对账结果
10. 系统向财务人员展示对账报告

**7）分支流**:
- 2.1 财务人员可以自定义对账时间范围
- 3.1 系统按支付渠道分组统计支付流水
- 4.1 系统处理多渠道分次支付的对账复杂性
- 6.1 对于合并支付，系统验证金额分配的正确性
- 8.1 对账报告包含预付款/尾款分类统计
- 8.2 对账报告包含各支付渠道的交易汇总
- 8.3 对账报告包含异常交易和差异分析
- 10.1 财务人员可以导出对账报告

**8）替代流**:
- 4.1 如果无法获取渠道对账单，系统记录失败原因，标记为"待重试"，流程继续
- 6.1 如果发现差异，系统尝试自动补偿处理
- 6.2 如果自动补偿失败，系统标记为"需人工审核"，通知财务人员

**9）后置条件**: 
- 对账任务已完成
- 对账报告已生成
- 差异项已标记并待处理

---

### 用例UC-PM-008: 处理对账差异

**1）用例编号**: UC-PM-008

**2）用例名称**: 处理对账差异

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：财务人员
- 次要参与者：系统管理员

**5）前置条件**: 
- 对账任务已完成
- 发现对账差异项

**6）成功流**:
1. 财务人员查看对账差异列表
2. 系统展示差异详情（差异类型、金额、渠道、交易号等）
3. 财务人员选择一条差异记录
4. 财务人员分析差异原因
5. 财务人员选择处理方式（自动补偿/人工审核/联系渠道）
6. 系统执行对应的处理操作
7. 系统更新差异状态
8. 系统同步业务系统状态
9. 系统记录处理结果
10. 系统更新对账报告

**7）分支流**:
- 4.1 财务人员可以查询关联的支付流水详细信息
- 4.2 财务人员可以查询支付渠道的交易详情
- 5.1 对于金额差异，财务人员可以调整支付单金额
- 5.2 对于状态差异，财务人员可以手动更新支付状态

**8）替代流**:
- 6.1 如果自动补偿失败，系统提示人工介入，返回步骤5
- 8.1 如果同步业务系统失败，系统记录失败原因，加入重试队列

**9）后置条件**: 
- 对账差异已处理
- 业务系统状态已同步
- 对账报告已更新

---

### 用例UC-PM-009: 生成支付统计报表

**1）用例编号**: UC-PM-009

**2）用例名称**: 生成支付统计报表

**3）用例类型**: 分析图表

**4）参与者**: 
- 主要参与者：财务人员
- 次要参与者：系统管理员

**5）前置条件**: 
- 财务人员已登录系统
- 系统中存在支付数据

**6）成功流**:
1. 财务人员进入报表生成页面
2. 财务人员选择报表类型（支付单完成率/客户支付行为/支付渠道效率/支付状态分布等）
3. 财务人员设置报表参数（时间范围、支付类型、经销商等）
4. 财务人员提交报表生成请求
5. 系统根据报表类型查询相关数据
6. 系统按支付单类型（预付款、尾款、其他费用、信用还款）统计分析
7. 系统统计各支付渠道的使用情况和效率
8. 系统分析合并支付和批量支付的使用情况
9. 系统计算统计指标（完成率、及时性、金额分布等）
10. 系统生成可视化图表
11. 系统生成报表文档
12. 系统向财务人员展示报表结果

**7）分支流**:
- 2.1 财务人员可以自定义报表维度和指标
- 6.1 系统可以按时间趋势进行分析
- 6.2 系统可以按经销商维度进行分组统计
- 10.1 系统可以生成多种类型的图表（柱状图、折线图、饼图等）
- 12.1 财务人员可以导出报表（Excel、PDF等格式）
- 12.2 财务人员可以保存报表模板供下次使用

**8）替代流**:
- 5.1 如果查询时间范围过大，系统提示优化查询条件，返回步骤3
- 5.2 如果没有符合条件的数据，系统显示"无数据"提示，流程结束

**9）后置条件**: 
- 报表已生成
- 财务人员获得统计分析结果

---

### 用例UC-PM-010: 监控支付异常

**1）用例编号**: UC-PM-010

**2）用例名称**: 监控支付异常

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：系统管理员
- 次要参与者：财务人员

**5）前置条件**: 
- 系统管理员已登录系统
- 监控系统已启动

**6）成功流**:
1. 系统实时监控支付单的执行情况和状态变化
2. 系统检测支付回调超时情况
3. 系统检测支付渠道异常
4. 系统检测大额支付风险
5. 系统检测长时间未支付订单
6. 系统检测支付超时情况
7. 系统记录异常事件
8. 系统根据异常类型和严重程度进行分级
9. 系统向系统管理员发送异常告警
10. 系统记录告警日志

**7）分支流**:
- 2.1 对于回调超时，系统自动触发补偿查询
- 3.1 对于渠道异常，系统自动切换备用渠道
- 4.1 对于大额支付，系统触发风险预警流程
- 5.1 对于长时间未支付，系统自动发送提醒通知
- 6.1 对于支付超时，系统自动执行超时处理规则

**8）替代流**:
- 9.1 如果告警发送失败，系统记录失败原因，加入重试队列

**9）后置条件**: 
- 异常事件已记录
- 相关人员已收到告警通知
- 自动处理流程已启动（如适用）

---

### 用例UC-PM-011: 处理支付回调重试

**1）用例编号**: UC-PM-011

**2）用例名称**: 处理支付回调重试

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：系统管理员
- 次要参与者：支付渠道

**5）前置条件**: 
- 支付回调处理失败或超时
- 系统检测到需要重试的回调

**6）成功流**:
1. 系统识别需要重试的支付回调
2. 系统检查重试次数是否超过限制
3. 系统主动向支付渠道发起补偿查询
4. 支付渠道返回支付状态
5. 系统根据查询结果更新支付流水状态
6. 系统更新支付单状态和金额
7. 系统向订单系统发送支付结果通知
8. 系统更新重试记录
9. 系统记录处理结果

**7）分支流**:
- 3.1 系统可以批量处理多个待重试的回调
- 4.1 如果查询结果为"支付中"，系统延迟下次重试

**8）替代流**:
- 2.1 如果重试次数超过限制，系统标记为"需人工处理"，通知系统管理员，流程结束
- 4.1 如果查询失败（网络故障等），系统延迟重试，流程结束
- 7.1 如果通知订单系统失败，系统将通知加入重试队列

**9）后置条件**: 
- 支付状态已更新（或标记为需人工处理）
- 重试记录已更新

---

### 用例UC-PM-012: 创建信用还款支付单

**1）用例编号**: UC-PM-012

**2）用例名称**: 创建信用还款支付单

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：信用管理系统（发起）
- 次要参与者：无

**5）前置条件**: 
- 信用管理系统已确定还款计划
- 经销商存在信用欠款

**6）成功流**:
1. 信用管理系统发送还款支付单创建请求
2. 请求包含关联业务ID（信用记录ID）、关联业务类型（CREDIT_RECORD）、经销商ID、还款金额、还款到期日等
3. 系统接收创建请求
4. 系统验证请求数据的完整性和合法性
5. 系统生成唯一的支付单流水号
6. 系统设置支付类型为"信用还款"
7. 系统设置关联业务信息（关联业务ID、关联业务类型、业务到期日）
8. 系统初始化支付单状态为"未支付"
9. 系统将支付单信息持久化到数据库
10. 系统向信用管理系统返回支付单创建成功结果

**7）分支流**:
- 无

**8）替代流**:
- 4.1 如果请求数据不完整或格式错误，系统返回验证失败信息，流程结束
- 4.2 如果还款金额不合理，系统返回金额验证失败信息，流程结束

**9）后置条件**: 
- 信用还款支付单已创建
- 支付类型为"信用还款"
- 支付单可按统一支付流程处理

---

### 用例UC-PM-013: 执行信用还款支付

**1）用例编号**: UC-PM-013

**2）用例名称**: 执行信用还款支付

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：经销商
- 次要参与者：支付渠道、信用管理系统

**5）前置条件**: 
- 信用还款支付单已创建
- 经销商已登录系统

**6）成功流**:
1. 经销商筛选支付单，包括信用还款支付单
2. 经销商选择一个或多个支付单（可包含信用还款和其他类型支付单）
3. 系统执行统一支付流程（参照用例UC-PM-003）
4. 支付完成后，系统更新支付单状态
5. 系统向信用管理系统发送还款结果通知

**7）分支流**:
- 2.1 经销商可以将信用还款支付单与其他类型支付单合并支付
- 2.2 经销商可以对信用还款支付单进行部分支付

**8）替代流**:
- 5.1 如果通知信用管理系统失败，系统将通知加入重试队列

**9）后置条件**: 
- 信用还款支付已完成
- 信用管理系统已收到还款通知
- 支付流水已记录

---

### 用例UC-PM-014: 查询信用还款记录

**1）用例编号**: UC-PM-014

**2）用例名称**: 查询信用还款记录

**3）用例类型**: 查询报表

**4）参与者**: 
- 主要参与者：经销商、信用管理系统
- 次要参与者：无

**5）前置条件**: 
- 参与者已登录系统
- 系统中存在信用还款支付单

**6）成功流**:
1. 参与者进入支付单查询页面
2. 参与者设置筛选条件，支付类型选择"信用还款"
3. 参与者可以通过关联业务ID查询特定信用记录的还款情况
4. 参与者提交查询请求
5. 系统根据条件查询信用还款支付单
6. 系统展示信用还款支付单列表
7. 系统展示每个支付单的详细信息（还款金额、已支付金额、状态、到期日等）
8. 系统展示还款支付流水历史

**7）分支流**:
- 2.1 参与者可以使用其他标准查询条件（状态、时间、金额等）
- 6.1 参与者可以导出查询结果

**8）替代流**:
- 5.1 如果未找到符合条件的信用还款支付单，系统显示"未找到相关记录"提示，流程结束

**9）后置条件**: 
- 参与者获得信用还款支付单信息
- 参与者了解还款进度和历史

---

### 用例UC-PM-015: 补偿查询支付状态

**1）用例编号**: UC-PM-015

**2）用例名称**: 补偿查询支付状态

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：经销商、系统管理员
- 次要参与者：支付渠道

**5）前置条件**: 
- 支付请求已发起
- 回调超时或用户主动刷新状态

**6）成功流**:
1. 参与者发起状态补偿查询请求
2. 系统根据支付单号查找支付流水
3. 系统获取支付渠道交易号
4. 系统向支付渠道发起状态查询请求
5. 支付渠道返回最新支付状态
6. 系统对比本地状态与渠道状态
7. 系统更新支付流水状态
8. 系统更新支付单状态和金额
9. 系统向订单系统同步状态变更
10. 系统向参与者展示最新状态

**7）分支流**:
- 1.1 系统可以通过定时任务自动触发批量补偿查询
- 6.1 如果状态一致，系统不做变更，直接返回当前状态
- 6.2 如果状态不一致，系统记录差异日志

**8）替代流**:
- 4.1 如果查询请求失败，系统提示网络故障，建议稍后重试，流程结束
- 5.1 如果支付渠道返回"交易不存在"，系统标记为异常，通知管理员，流程结束

**9）后置条件**: 
- 支付状态已更新为最新状态
- 状态不一致情况已记录

---

## 4. 用例关系矩阵

| 用例编号 | 用例名称 | 主要参与者 | 相关用例 | 包含关系 | 扩展关系 |
|---------|---------|----------|---------|---------|---------|
| UC-PM-001 | 接收支付单创建请求 | 订单系统 | - | - | - |
| UC-PM-002 | 筛选支付单 | 经销商 | UC-PM-003 | - | - |
| UC-PM-003 | 执行支付操作 | 经销商 | UC-PM-004 | UC-PM-002 | - |
| UC-PM-004 | 处理支付回调 | 支付渠道 | UC-PM-003 | - | UC-PM-011 |
| UC-PM-005 | 查询支付单信息 | 经销商 | - | - | - |
| UC-PM-006 | 接收退款执行指令 | 订单系统 | - | - | - |
| UC-PM-007 | 执行支付对账 | 财务人员 | UC-PM-008 | - | - |
| UC-PM-008 | 处理对账差异 | 财务人员 | UC-PM-007 | - | - |
| UC-PM-009 | 生成支付统计报表 | 财务人员 | - | - | - |
| UC-PM-010 | 监控支付异常 | 系统管理员 | UC-PM-011 | - | - |
| UC-PM-011 | 处理支付回调重试 | 系统管理员 | UC-PM-004 | - | - |
| UC-PM-012 | 创建信用还款支付单 | 信用管理系统 | UC-PM-013 | - | - |
| UC-PM-013 | 执行信用还款支付 | 经销商 | UC-PM-003 | UC-PM-003 | - |
| UC-PM-014 | 查询信用还款记录 | 经销商 | UC-PM-005 | UC-PM-005 | - |
| UC-PM-015 | 补偿查询支付状态 | 经销商 | UC-PM-004 | - | - |

## 5. 用例优先级

| 优先级 | 用例编号 | 用例名称 | 说明 |
|-------|---------|---------|------|
| **高** | UC-PM-001 | 接收支付单创建请求 | 核心业务流程入口 |
| **高** | UC-PM-003 | 执行支付操作 | 核心支付功能 |
| **高** | UC-PM-004 | 处理支付回调 | 核心支付完成流程 |
| **高** | UC-PM-005 | 查询支付单信息 | 基础查询功能 |
| **中** | UC-PM-002 | 筛选支付单 | 支付操作辅助功能 |
| **中** | UC-PM-006 | 接收退款执行指令 | 重要业务功能 |
| **中** | UC-PM-007 | 执行支付对账 | 财务管理功能 |
| **中** | UC-PM-012 | 创建信用还款支付单 | 信用业务支持 |
| **中** | UC-PM-013 | 执行信用还款支付 | 信用业务支持 |
| **低** | UC-PM-008 | 处理对账差异 | 异常处理功能 |
| **低** | UC-PM-009 | 生成支付统计报表 | 分析统计功能 |
| **低** | UC-PM-010 | 监控支付异常 | 系统监控功能 |
| **低** | UC-PM-011 | 处理支付回调重试 | 异常恢复功能 |
| **低** | UC-PM-014 | 查询信用还款记录 | 查询辅助功能 |
| **低** | UC-PM-015 | 补偿查询支付状态 | 状态同步功能 |

## 6. 总结

本用例模型文档基于《支付模块需求设计.md v1.4》，通过系统的需求分析，完成了以下工作：

1. **识别了7个参与者**：
   - 主要参与者：经销商、财务人员、系统管理员
   - 次要参与者：订单系统、支付渠道、信用管理系统、财务系统

2. **识别了6个功能模块**：
   - 支付单管理模块
   - 支付执行模块
   - 支付查询模块
   - 退款管理模块
   - 对账管理模块
   - 信用还款模块

3. **绘制了6个用例图**，涵盖所有主要业务场景

4. **编写了15个详细用例描述**，每个用例包含：
   - 用例编号
   - 用例名称
   - 用例类型（业务操作/查询报表/分析图表）
   - 参与者
   - 前置条件
   - 成功流（主流程）
   - 分支流
   - 替代流
   - 后置条件

5. **建立了用例关系矩阵**，明确用例之间的包含和扩展关系

6. **定义了用例优先级**，为系统开发提供实施顺序参考

本用例模型为支付模块的详细设计和开发实现提供了完整的业务需求视图，确保系统设计能够满足所有业务场景的需求。
