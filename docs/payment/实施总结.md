# 支付模块接口设计实现总结

## 实施日期
2025-01-15

## 需求来源
Issue: 支付模块接口设计

### 原始需求
支付模块需要提供其他模块进行调用的接口，采用java内部代码调用，先预留：
1. 创建支付单接口
2. 退款接口

支付模块需要增加对外的rest接口：
1. 批量支付接口: 前端调用批量支付接口
2. 查询当前经销商可用支付渠道

---

## 实施内容

### 1. 内部Java接口（系统间调用）

#### 1.1 IPaymentInternalService 接口
- **位置**: `com.bytz.modules.cms.payment.application.IPaymentInternalService`
- **实现类**: `PaymentApplicationService`
- **目的**: 提供给订单系统、信用管理系统等内部模块调用

#### 1.2 接口方法

**createPayment 方法**:
- **签名**: `PaymentAggregate createPayment(CreatePaymentCommand command)`
- **用途**: 创建支付单
- **调用方**: 订单系统、信用管理系统
- **事件**: 发布 `PaymentCreatedEvent`

**executeRefund 方法**:
- **签名**: `String executeRefund(ExecuteRefundCommand command)`
- **用途**: 执行退款
- **调用方**: 订单系统
- **事件**: 发布 `RefundExecutedEvent`

### 2. 外部REST接口（前端调用）

#### 2.1 批量支付接口
- **端点**: `POST /api/v1/payments/batch-pay`
- **请求体**: `BatchPaymentExecuteRO`
  - `paymentItems`: 支付单项列表
    - `paymentCode`: 支付单号
    - `amount`: 支付金额
  - `paymentChannel`: 支付渠道
- **响应体**: `BatchPaymentResultVO`
  - `channelTransactionNumber`: 渠道交易号
  - `totalAmount`: 总金额
  - `paymentCount`: 支付单数量
  - `paymentResults`: 支付结果列表

#### 2.2 查询可用支付渠道接口
- **端点**: `GET /api/v1/payments/available-channels`
- **请求参数**: 
  - `X-Reseller-Id` (Header): 经销商ID
- **响应体**: `List<PaymentChannelVO>`
  - `channelCode`: 渠道代码
  - `channelName`: 渠道名称
  - `channelDescription`: 渠道描述
  - `available`: 是否可用
  - `unavailableReason`: 不可用原因

### 3. 应用服务层

#### 3.1 PaymentExecutionApplicationService
- **职责**: 协调批量支付执行和渠道查询
- **方法**:
  - `executeBatchPayment()`: 执行批量支付
  - `queryAvailableChannels()`: 查询可用渠道
  - `queryChannelAvailabilityDetails()`: 查询渠道详细信息

### 4. 领域层增强

#### 4.1 PaymentAggregate 增强
- 添加 `validateRefundable()` 方法
- 用于退款前置条件验证

### 5. DTOs（数据传输对象）

新增以下DTOs：
- `BatchPaymentExecuteRO`: 批量支付请求对象
- `BatchPaymentResultVO`: 批量支付响应对象
- `PaymentChannelVO`: 支付渠道响应对象

### 6. MapStruct 转换器更新

**PaymentAssembler** 新增方法：
- `toBatchPaymentCommand()`: RO转Command
- `toChannelVO()`: 渠道枚举转VO
- `toChannelVOs()`: 渠道列表转VO列表

---

## 架构设计

### 分层架构
```
interfaces/           # 接口层 (REST Controllers, RO/VO)
  └─ PaymentController
application/          # 应用层 (用例编排)
  ├─ IPaymentInternalService (内部接口)
  ├─ PaymentApplicationService (实现内部接口)
  └─ PaymentExecutionApplicationService (批量支付编排)
domain/              # 领域层 (业务逻辑)
  └─ PaymentDomainService (领域服务)
infrastructure/      # 基础设施层 (技术实现)
  └─ channel/ (支付渠道)
```

### 接口类型划分

**内部接口**（Java代码调用）:
- 通过Spring依赖注入
- 使用Command对象传参
- 返回领域对象
- 发布领域事件

**外部接口**（HTTP REST调用）:
- 通过HTTP协议
- 使用RO接收请求
- 返回VO响应
- 调用应用服务

---

## 文档更新

### 1. payment.yml 更新
添加以下章节：
- `applicationServices`: 应用服务定义
- `restInterfaces`: REST接口定义
- `internalInterfaces`: 内部接口定义
- `dtos`: 数据传输对象定义

### 2. 新增使用文档
创建 `接口使用说明.md`，包含：
- 接口概述
- 详细接口说明
- 代码示例（Java和JavaScript）
- 完整流程示例
- 安全建议

---

## 代码质量

### 编译状态
- ✅ Maven编译通过 (`mvn clean compile`)
- ✅ 所有新增代码无编译错误
- ⚠️ 部分旧测试代码存在类型不匹配问题（与本次实现无关）

### 代码规范
- ✅ 遵循DDD分层架构
- ✅ 使用MapStruct进行对象转换
- ✅ 应用层无业务逻辑
- ✅ 使用Command模式封装参数
- ✅ 正确的事务和事件处理

---

## 使用示例

### 内部接口使用示例

**订单系统创建支付单**:
```java
@Autowired
private IPaymentInternalService paymentInternalService;

public void createOrder(Order order) {
    // 创建支付单
    CreatePaymentCommand command = CreatePaymentCommand.builder()
            .orderId(order.getOrderNo())
            .resellerId(order.getResellerId())
            .paymentAmount(order.getTotalAmount())
            .paymentType(PaymentType.ADVANCE_PAYMENT)
            .build();
    
    PaymentAggregate payment = paymentInternalService.createPayment(command);
    order.setPaymentCode(payment.getCode());
}
```

**订单系统执行退款**:
```java
@Autowired
private IPaymentInternalService paymentInternalService;

public void executeRefund(RefundOrder refundOrder) {
    ExecuteRefundCommand command = ExecuteRefundCommand.builder()
            .refundOrderId(refundOrder.getRefundNo())
            .paymentId(refundOrder.getPaymentId())
            .refundAmount(refundOrder.getRefundAmount())
            .refundReason(refundOrder.getReason())
            .originalTransactionId(refundOrder.getOriginalTransactionId())
            .build();
    
    String refundTransactionId = paymentInternalService.executeRefund(command);
}
```

### 外部接口使用示例

**前端批量支付**:
```javascript
// 批量支付
const response = await fetch('/api/v1/payments/batch-pay', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Reseller-Id': 'RESELLER001'
  },
  body: JSON.stringify({
    paymentItems: [
      { paymentCode: 'PAY001', amount: 5000 },
      { paymentCode: 'PAY002', amount: 3000 }
    ],
    paymentChannel: 'ONLINE_PAYMENT'
  })
});

const result = await response.json();
console.log('渠道交易号:', result.channelTransactionNumber);
```

**前端查询可用渠道**:
```javascript
// 查询可用支付渠道
const response = await fetch('/api/v1/payments/available-channels', {
  method: 'GET',
  headers: {
    'X-Reseller-Id': 'RESELLER001'
  }
});

const channels = await response.json();
// 显示可用渠道列表
channels.forEach(channel => {
  console.log(`${channel.channelName}: ${channel.available ? '可用' : '不可用'}`);
});
```

---

## 技术要点

### 1. 内部接口设计
- 使用接口定义，便于mock测试
- 使用Command对象封装参数
- 返回领域对象而非DTO
- 事务在实现类中管理

### 2. REST接口设计
- 遵循RESTful规范
- 使用RO/VO进行数据传输
- 参数验证使用JSR-380注解
- 错误处理统一

### 3. 应用服务职责
- 不包含业务逻辑
- 负责用例协调
- 处理事务边界
- 发布领域事件

### 4. 领域服务职责
- 包含跨聚合业务逻辑
- 协调多个聚合根
- 调用基础设施层
- 执行批量操作

---

## 注意事项

### 安全性
1. ❗ 创建支付单接口（`POST /api/v1/payments/`）已标记为废弃
2. ✅ 批量支付接口需要严格的权限验证
3. ✅ 渠道回调必须验证签名
4. ✅ 所有金额计算使用BigDecimal

### 异步处理
1. 批量支付是异步操作
2. 最终结果需要等待渠道回调
3. 前端应轮询或使用WebSocket获取结果

### 扩展性
1. 接口设计支持多渠道扩展
2. 支持多支付单合并支付
3. 支持部分支付和分批支付

---

## 相关文档

1. [payment.yml v2.0](./payment.yml) - DDD设计规范文档
2. [接口使用说明.md](./接口使用说明.md) - 接口使用指南
3. [支付模块需求设计文档 v1.5](./支付模块需求设计.md) - 需求文档
4. [支付模块用例模型文档 v1.0](./支付模块用例模型.md) - 用例文档
5. [全局术语表 v3.0](../Glossary.md) - 术语定义

---

## 实施团队

- 实施人: AI Copilot
- 审核人: KyleWangkq
- 实施日期: 2025-01-15

---

## 后续工作建议

### 短期
1. 修复测试代码中的类型不匹配问题
2. 添加批量支付和渠道查询的单元测试
3. 完善认证授权机制

### 中期
1. 实现支付渠道的实际对接
2. 完善支付回调处理逻辑
3. 添加支付状态补偿查询功能

### 长期
1. 支持更多支付渠道
2. 优化批量支付性能
3. 增加支付数据分析功能
