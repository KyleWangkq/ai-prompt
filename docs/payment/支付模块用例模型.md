# 支付模块用例模型文档

## 文档信息
| 项目 | 内容 |
|------|------|
| **文档名称** | 支付模块用例模型文档 |
| **项目名称** | 企业间特种设备定制交易系统 - 支付模块 |
| **文档版本** | v1.1 |
| **创建日期** | 2025年1月 |
| **基准文档** | 支付模块需求设计.md v1.4 |
| **文档状态** | 修订版 |

## 目录
- [1. 参与者识别](#1-参与者识别)
- [2. 用例图](#2-用例图)
- [3. 用例描述](#3-用例描述)

## 1. 参与者识别

根据支付模块需求设计文档，识别出以下参与者：

### 1.1 主要参与者（Primary Actors）

| 参与者名称 | 英文名称 | 描述 | 职责 |
|----------|----------|------|------|
| **经销商** | Reseller | B2B交易中的企业买方，支付发起方 | 发起支付、选择支付单、执行支付操作、查询支付状态 |
| **财务人员** | Finance Staff | 企业财务部门工作人员 | 查询支付流水、监控支付状态 |
| **系统管理员** | System Administrator | 支付系统管理人员 | 监控系统运行、处理异常、配置系统参数 |

### 1.2 次要参与者（Secondary Actors）

| 参与者名称 | 英文名称 | 描述 | 职责 |
|----------|----------|------|------|
| **订单系统** | Order System | 上游业务系统，管理订单生命周期 | 创建支付单、接收支付结果通知、发起退款指令 |
| **支付渠道** | Payment Channel | 多种支付渠道（如银行、第三方平台等），由系统配置和代码实现 | 处理支付请求、返回支付结果、发送支付回调、支持渠道可用性查询与校验 |
| **信用管理系统** | Credit Management System | 管理企业信用额度和还款 | 创建信用还款支付单、接收还款结果通知 |

### 1.3 信用还款与订单关联说明

- 定义：信用还款是对某一订单产生的“信用支付”进行的还款动作，业务粒度为「订单-信用支付记录」。
- 关联规则：
        - 创建信用还款支付单时，必须携带订单号（orderNo），系统将校验该订单号与信用记录（如 creditRecordId/creditPlanId）的一致性；不一致或缺失则拒绝创建。
        - 在支付执行、渠道回调、补偿查询与结果展示全流程中，均保持「支付单 → 信用记录 → 订单号」的可追溯链路，确保可最终定位到订单。
        - 合并支付场景下，每个信用还款支付单仍各自绑定其订单号；对应的支付流水按支付单维度分别记录并回写订单号。
        - 向订单系统、信用管理系统进行状态/结果通知时，应包含订单号，便于上下游关联系统核对。
- 数据字段要求：
        - 支付类型为 CREDIT_REPAYMENT 的支付单：orderNo 必填；同时需要提供信用记录标识（如 creditRecordId），系统将校验二者绑定关系。
        - 支付流水、退款流水等明细记录中需包含 orderNo 字段，确保查询与对账的一致性。
 - 异常处理：缺少订单号或订单号与信用记录不匹配，视为一致性校验失败，必须阻断业务流程并返回明确错误。

## 2. 用例图

### 2.1 支付单管理模块

```
                    ┌────────────────┐
                    │   订单系统     │
                    └───────┬────────┘
                            │
                            │ 创建支付单
                            │
                            ▼
                    ┌───────────────┐
                    │ 接收支付单创建│
                    │   请求        │◄──────────┐
                    └───────────────┘           │
                            │                   │
                            │                   │
                            ▼                   │
                    ┌───────────────┐           │
                    │ 验证支付单信息│           │
                    └───────────────┘           │
                            │                   │
                            │                   │
                            ▼                   │
                    ┌───────────────┐           │
            ┌───────┤ 生成支付单号  │           │
            │       └───────────────┘           │
            │                                   │
    ┌───────▼────────┐                         │
    │   经销商       ├─────────────────────────┘
    │               │       查询支付单
    └───────┬────────┘
            │
            │ 查询支付单状态
            │
            ▼
    ┌───────────────┐
    │ 查询支付单信息│
    └───────────────┘
```

### 2.2 支付执行模块

```
    ┌───────────────┐
    │   经销商      │
    └───────┬───────┘
            │
            │ 选择支付单
            │
            ▼
    ┌───────────────┐
    │ 筛选支付单    │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐              ┌───────────────┐
    │ 查询可用渠道  ├──────────────►│  支付渠道列表 │
    └───────┬───────┘              └───────┬───────┘
            │                              │
            │                              │ 选择渠道并校验可用性
            ▼                              │
    ┌───────────────┐                     │
    │ 选择支付渠道  │                     │
    └───────┬───────┘                     │
            │                              │
            │                              │
            ▼                              ▼
    ┌───────────────┐              ┌───────────────┐
    │ 分配支付金额  │              │ 处理支付回调  │
    └───────┬───────┘              └───────┬───────┘
            │                              │
            │                              │
            ▼                              ▼
    ┌───────────────┐              ┌───────────────┐
    │ 执行支付操作  ├──────────────►│ 处理支付回调  │
    └───────┬───────┘              └───────┬───────┘
            │                              │
            │                              │
            ▼                              ▼
    ┌───────────────┐              ┌───────────────┐
    │ 更新支付状态  │              │ 通知订单系统  │
    └───────────────┘              └───────────────┘
```

### 2.3 支付查询模块

```
    ┌───────────────┐
    │   经销商      │
    └───────┬───────┘
            │
            │ 查询支付结果
            │
            ▼
    ┌───────────────┐
    │ 设置查询条件  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 查询支付单    │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 查询支付流水  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 展示查询结果  │
    └───────────────┘


    ┌───────────────┐
    │  财务人员     │
    └───────┬───────┘
            │
            │ 生成支付报表
            │
            ▼
    ┌───────────────┐
    │ 统计支付数据  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 导出报表数据  │
    └───────────────┘
```

### 2.4 退款管理模块

```
    ┌───────────────┐
    │  订单系统     │
    └───────┬───────┘
            │
            │ 发起退款指令
            │
            ▼
    ┌───────────────┐
    │ 接收退款请求  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 选择支付流水  │
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐              ┌───────────────┐
    │ 执行退款操作  ├──────────────►│  支付渠道     │
    └───────┬───────┘              └───────┬───────┘
            │                              │
            │                              │ 返回退款结果
            ▼                              │
    ┌───────────────┐                     │
    │ 更新退款金额  │◄────────────────────┘
    └───────┬───────┘
            │
            │
            ▼
    ┌───────────────┐
    │ 通知订单系统  │
    └───────────────┘
```

## 3. 用例描述

### 用例UC-PM-001: 接收支付单创建请求（含信用还款）

**1）用例编号**: UC-PM-001

**2）用例名称**: 接收支付单创建请求

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：订单系统（发起）、信用管理系统（发起信用还款支付单）
- 次要参与者：无

**5）前置条件**: 
- 订单系统已生成订单，或信用管理系统已确定还款计划
- 订单或信用记录需要创建对应的支付单

**6）成功流**:
1. 发起方（订单系统或信用管理系统）发送支付单创建请求，包含订单号（orderNo）、经销商ID、支付金额、支付类型等信息；当支付类型为 CREDIT_REPAYMENT 时，还必须包含信用记录ID并与该订单号匹配
2. 系统接收创建请求
3. 系统验证请求数据的完整性和合法性
4. 若为 CREDIT_REPAYMENT，系统校验订单号与信用记录的绑定关系（订单号与 creditRecordId 一致且有效）
4. 系统检查支付单唯一性，避免重复创建
5. 系统验证支付金额的合理性
6. 系统生成唯一的支付单流水号
7. 系统初始化支付单状态为"未支付"
8. 系统将支付单信息持久化到数据库
9. 系统向发起方返回支付单创建成功结果，包含支付单号

**7）分支流**:
- 订单系统发起普通支付单，信用管理系统发起信用还款支付单（设置支付类型为 CREDIT_REPAYMENT，且必须携带订单号并与信用记录一致）

**8）替代流**:
- 3.1 如果请求数据不完整或格式错误，系统返回验证失败信息，流程结束
- 3.2 如果为信用还款但缺少订单号或信用记录ID，系统返回验证失败信息，流程结束
- 3.3 如果订单号与信用记录不匹配，系统返回一致性校验失败信息，流程结束
- 4.1 如果检测到重复支付单，系统返回已存在的支付单信息，流程结束
- 5.1 如果支付金额不合理（如为负数或超出限制），系统返回金额验证失败信息，流程结束

**9）后置条件**: 
- 系统成功创建支付单记录
- 支付单状态为"未支付"
- 发起方获得支付单号

---

### 用例UC-PM-003: 执行支付操作（含信用还款）

**1）用例编号**: UC-PM-003

**2）用例名称**: 执行支付操作

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：经销商
- 次要参与者：支付渠道、信用管理系统（信用还款结果通知）

**5）前置条件**: 
- 经销商已登录系统
- 经销商已选择至少一个待支付的支付单（包括普通支付单和信用还款支付单）
- 支付单状态允许支付（未支付或部分支付）

**6）成功流**:
1. 经销商选择一个或多个支付单（可包含信用还款类型）
2. 系统验证所选支付单属于同一经销商
3. 系统检查支付单状态是否允许支付
4. 经销商查询当前可用支付渠道列表
5. 经销商选择支付渠道
6. 系统校验所选渠道对当前用户是否可用
7. 系统显示每个支付单的待支付金额
8. 经销商为每个支付单分配本次支付金额
9. 系统计算总支付金额（所有参与支付单的金额之和）
10. 系统校验每个支付单的支付金额不超过其待支付金额
11. 系统调用支付渠道创建支付请求
12. 支付渠道返回支付渠道交易号
13. 系统为每个参与支付的支付单创建独立的支付流水记录
14. 系统更新流水状态为"支付中"
15. 系统更新所有参与支付的支付单状态为"支付中"
16. 系统向经销商展示支付操作结果
17. 对于信用还款支付单，系统向信用管理系统发送还款结果通知

**7）分支流**:
- 经销商可将信用还款支付单与其他类型支付单合并支付
- 经销商可对信用还款支付单进行部分支付
- 经销商可多次查询渠道列表，切换渠道
- 如果渠道不可用，系统提示并要求重新选择
- 合并支付时，信用还款支付单对应的每条支付流水必须保留并回写其订单号，以便后续查询与对账

**8）替代流**:
- 2.1 如果所选支付单不属于同一经销商，系统提示验证失败，返回步骤1
- 3.1 如果存在不允许支付的支付单，系统提示状态错误，返回步骤1
- 6.1 如果所选渠道对当前用户不可用，系统提示渠道不可用，返回步骤4
- 10.1 如果支付金额超过待支付金额，系统提示金额错误，返回步骤8
- 11.1 如果支付渠道调用失败，系统记录失败原因，提示用户重试或更换渠道，流程结束
- 17.1 如果通知信用管理系统失败，系统将通知加入重试队列

**9）后置条件**: 
- 支付请求已提交到支付渠道
- 支付流水记录已创建
- 支付单状态更新为"支付中"
- 信用管理系统已收到还款通知（如有信用还款支付单）
- 等待支付渠道回调确认

---

### 用例UC-PM-005: 查询支付单信息

**1）用例编号**: UC-PM-005

**2）用例名称**: 查询支付单信息

**3）用例类型**: 查询报表

**4）参与者**: 
- 主要参与者：经销商、信用管理系统
- 次要参与者：无

**5）前置条件**: 
- 参与者已登录系统

**6）成功流**:
1. 参与者进入支付单查询页面
2. 参与者选择查询方式（支付单号、订单号、交易号、经销商ID、关联业务ID）
3. 参与者输入查询条件
4. 参与者提交查询请求
5. 系统根据查询条件检索支付单（包括普通支付单和信用还款支付单）
6. 系统展示支付单基础信息（所属订单号、总金额、已支付金额、已退款金额、实际收款金额、状态、时间、支付类型等）
7. 系统展示支付进度（已支付/总金额）
8. 系统展示支付流水历史记录
9. 系统展示关联订单和经销商信息
10. 对于信用还款支付单，系统提供跳转链接到信用系统模块查看详细信用记录

**7）分支流**:
- 2.1 参与者可以使用条件筛选（支付状态、支付类型、时间范围、金额范围、支付渠道）
- 2.2 参与者可以通过支付类型选择"信用还款"筛选信用还款记录
- 2.3 参与者可以通过关联业务ID查询特定信用记录的还款情况
- 2.4 对于信用还款，支持按「订单号 + 信用记录ID」联合查询，或仅依据订单号查询该订单下的全部信用还款支付单
- 6.1 参与者可以查看支付单详细信息
- 8.1 参与者可以查看每条支付流水的详细信息（渠道、金额、时间、状态）
- 8.2 对于合并支付，系统展示渠道交易号关联的所有支付流水
- 9.1 参与者可以导出查询结果
- 10.1 对于信用还款支付单，参与者可以点击跳转链接访问信用系统模块查看详细信用记录

**8）替代流**:
- 5.1 如果查询条件无效，系统提示输入错误，返回步骤3
- 5.2 如果未找到符合条件的支付单，系统显示"未找到相关支付单"提示，流程结束

**9）后置条件**: 
- 参与者获得支付单详细信息（包括信用还款支付单）
- 参与者了解支付进度和历史

---

### 用例UC-PM-006: 接收退款执行指令

**1）用例编号**: UC-PM-006

**2）用例名称**: 接收退款执行指令

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：订单系统（发起）
- 次要参与者：支付渠道

**5）前置条件**: 
- 订单系统已完成退款审批
- 原支付单存在且已支付
- 退款金额不超过已支付金额

**6）成功流**:
1. 订单系统发送退款执行指令，包含退款单号、支付单号、退款金额、退款原因等
2. 系统接收退款指令
3. 系统验证退款指令的完整性和合法性
4. 系统根据支付单号查找原支付单
5. 系统验证支付单状态是否允许退款
6. 系统验证退款金额是否超过可退款金额
7. 系统查询原支付单的成功支付流水记录
8. 系统按支付时间倒序排列支付流水
9. 系统根据配置的策略选择退款流水（最新流水退款/指定流水退款/多流水分摊）
10. 系统调用对应支付渠道的退款接口
11. 支付渠道返回退款处理结果
12. 系统创建退款流水记录（流水类型为"退款"，金额为负数）
13. 系统更新支付单的已退款金额
14. 系统重新计算实际收款金额（已支付金额 - 已退款金额）
15. 系统根据退款比例更新支付单退款状态（部分退款/全额退款）
16. 系统保存退款流水和支付单变更
17. 系统向订单系统发送退款结果通知

**7）分支流**:
- 9.1 如果选择指定流水退款，系统使用指定的支付流水进行退款
- 9.2 如果选择多流水分摊退款，系统按支付金额比例分摊到多个流水

**8）替代流**:
- 3.1 如果退款指令数据不完整或格式错误，系统返回验证失败信息，流程结束
- 4.1 如果未找到原支付单，系统返回"支付单不存在"错误，流程结束
- 5.1 如果支付单状态不允许退款，系统返回状态错误信息，流程结束
- 6.1 如果退款金额超过可退款金额，系统返回金额错误信息，流程结束
- 10.1 如果支付渠道退款失败，系统记录失败原因，支持重试机制，返回退款失败结果
- 17.1 如果通知订单系统失败，系统将通知加入重试队列

**9）后置条件**: 
- 退款流水记录已创建
- 支付单退款金额已更新
- 支付单退款状态已更新
- 订单系统已收到退款结果通知

---

### 用例UC-PM-009: 补偿查询支付状态

**1）用例编号**: UC-PM-009

**2）用例名称**: 补偿查询支付状态

**3）用例类型**: 业务操作

**4）参与者**: 
- 主要参与者：经销商、系统管理员
- 次要参与者：支付渠道

**5）前置条件**: 
- 支付请求已发起
- 回调超时或用户主动刷新状态

**6）成功流**:
1. 参与者发起状态补偿查询请求
2. 系统根据支付单号查找支付流水
3. 系统获取支付渠道交易号
4. 系统向支付渠道发起状态查询请求
5. 支付渠道返回最新支付状态
6. 系统对比本地状态与渠道状态
7. 系统更新支付流水状态
8. 系统更新支付单状态和金额
9. 系统向订单系统同步状态变更
10. 系统向参与者展示最新状态

**7）分支流**:
- 1.1 系统可以通过定时任务自动触发批量补偿查询
- 6.1 如果状态一致，系统不做变更，直接返回当前状态
- 6.2 如果状态不一致，系统记录差异日志

**8）替代流**:
- 4.1 如果查询请求失败，系统提示网络故障，建议稍后重试，流程结束
- 5.1 如果支付渠道返回"交易不存在"，系统标记为异常，通知管理员，流程结束

**9）后置条件**: 
- 支付状态已更新为最新状态
- 状态不一致情况已记录

---

## 4. 用例关系矩阵

| 用例编号 | 用例名称 | 主要参与者 | 相关用例 | 包含关系 | 扩展关系 |
|---------|---------|----------|---------|---------|---------|
| UC-PM-001 | 接收支付单创建请求 | 订单系统、信用管理系统 | - | - | - |
| UC-PM-002 | 筛选支付单 | 经销商 | UC-PM-003 | - | - |
| UC-PM-003 | 执行支付操作 | 经销商 | UC-PM-004 | UC-PM-002 | - |
| UC-PM-004 | 处理支付回调 | 支付渠道 | UC-PM-003 | - | - |
| UC-PM-005 | 查询支付单信息 | 经销商、信用管理系统 | - | - | - |
| UC-PM-006 | 接收退款执行指令 | 订单系统 | - | - | - |
| UC-PM-009 | 补偿查询支付状态 | 经销商 | UC-PM-004 | - | - |

## 5. 用例优先级

| 优先级 | 用例编号 | 用例名称 | 说明 |
|-------|---------|---------|------|
| **高** | UC-PM-001 | 接收支付单创建请求 | 核心业务流程入口，含信用还款场景 |
| **高** | UC-PM-003 | 执行支付操作 | 核心支付功能，含信用还款场景 |
| **高** | UC-PM-004 | 处理支付回调 | 核心支付完成流程 |
| **高** | UC-PM-005 | 查询支付单信息 | 基础查询功能 |
| **中** | UC-PM-002 | 筛选支付单 | 支付操作辅助功能 |
| **中** | UC-PM-006 | 接收退款执行指令 | 重要业务功能 |
| **低** | UC-PM-009 | 补偿查询支付状态 | 状态同步功能 |

## 6. 总结

本用例模型文档基于《支付模块需求设计.md v1.4》，通过系统的需求分析，完成了以下工作：

1. **识别了6个参与者**：
   - 主要参与者：经销商、财务人员、系统管理员
   - 次要参与者：订单系统、支付渠道、信用管理系统

2. **识别了5个功能模块**：
   - 支付单管理模块
   - 支付执行模块
   - 支付查询模块
   - 退款管理模块
   - 信用还款模块（已合并为支付类型处理）

3. **绘制了5个用例图**，涵盖所有主要业务场景

4. **编写了7个详细用例描述**，每个用例包含：
   - 用例编号
   - 用例名称
   - 用例类型（业务操作/查询报表/分析图表）
   - 参与者
   - 前置条件
   - 成功流（主流程）
   - 分支流
   - 替代流
   - 后置条件

5. **建立了用例关系矩阵**，明确用例之间的包含和扩展关系

6. **定义了用例优先级**，为系统开发提供实施顺序参考

> 本用例模型已将信用还款相关流程统一归入支付单创建和支付执行用例，避免重复，确保设计简洁、易于实现和维护。
