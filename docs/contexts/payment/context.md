```markdown
# 支付上下文 (Payment Context)

## 限界上下文设计文档 v2.0

### 文档信息
| 项目 | 内容 |
|------|------|
| **文档名称** | 支付上下文设计文档 |
| **项目名称** | 企业间特种设备定制交易系统 - 支付模块 |
| **文档版本** | v2.0 |
| **创建日期** | 2025年9月26日 |
| **更新日期** | 2025年9月26日 |
| **术语基准** | 全局词汇表 v2.0 |

### 上下文名称(Context Name)
**Payment Context** (支付上下文)

### 核心职责(Core Responsibility)
负责企业间特种设备定制交易系统中的**支付单**管理和**支付执行**，包括支付生命周期管理、支付渠道集成、退款执行处理、对账管理和状态通知。专注于支付业务的核心逻辑，与订单系统、财务系统、信用管理系统协同工作。

### 领域专家(Domain Expert)
- 支付业务产品经理 (Payment Product Manager)
- 财务结算专家 (Financial Settlement Expert)  
- 支付渠道技术专家 (Payment Channel Technical Expert)
- B2B交易业务专家 (B2B Transaction Business Expert)
- 信用管理专家 (Credit Management Expert)

### 聚合列表(Aggregates)
1. **Payment** (支付单聚合) - 核心聚合根，管理支付单的完整生命周期，包括支付状态、金额管理和交易流水
2. **PaymentTransaction** (交易流水聚合) - 管理具体的支付和退款操作记录，支持退款选择和对账处理

### 边界定义(Boundary Definition)

#### 包含的功能 (Included Functions)
| 功能模块 | 具体职责 | 核心概念 |
|----------|----------|----------|
| **支付单管理** | 支付单创建、状态管理、生命周期跟踪 | 支付单、支付单号、支付状态 |
| **支付执行** | 支付请求处理、支付渠道调用、支付回调处理 | 支付渠道、合并支付、部分支付 |
| **交易流水管理** | 支付和退款流水记录、流水状态管理 | 交易流水、交易号、流水类型 |
| **退款执行** | 接收退款指令、选择支付流水、执行退款操作 | 退款执行、已退款金额、实际收款金额 |
| **金额管理** | 支付金额、已支付金额、待支付金额计算 | 支付金额、已支付金额、待支付金额 |
| **信用还款** | 信用还款支付单处理、还款状态管理 | 信用还款、还款支付单、关联业务 |
| **对账管理** | 与支付渠道对账、差异处理 | 对账管理、支付凭证 |
| **状态通知** | 向外部系统发送支付状态变更通知 | 支付通知、支付结果通知接口 |

#### 不包含的功能 (Excluded Functions)
| 功能模块 | 负责系统 | 说明 |
|----------|----------|------|
| **订单管理** | 订单系统 (Order System) | 订单创建、状态管理、生产流程 |
| **退款审批** | 订单系统 (Order System) | 退款申请、业务审核、审批流程 |
| **用户管理** | 用户系统 (User System) | 用户认证、权限管理、经销商信息 |
| **财务核算** | 财务系统 (Financial System) | 会计处理、财务报告、税务管理 |
| **信用管理** | 信用管理系统 (Credit Management System) | 信用评估、额度管理、还款计划制定 |
| **商品管理** | 商品系统 (Product System) | 商品信息、价格管理、库存管理 |

### 通用语言定义(Ubiquitous Language)
> 基于全局词汇表 v2.0，确保术语使用的一致性

#### 核心业务术语 (Core Business Terms)
| 中文术语 | 英文术语 | 上下文定义 |
|---------|----------|------------|
| **支付单** | Payment | 支付上下文的聚合根，承载完整的支付业务逻辑和生命周期管理 |
| **支付单号** | Payment ID | 支付单的唯一业务标识，确保支付记录的可追溯性和数据一致性 |
| **交易流水** | Payment Transaction | 支付单的子实体，记录每次具体的支付操作，支持退款选择和对账 |
| **支付渠道** | Payment Channel | 支付执行的具体路径，决定支付方式、处理时间和费用结构 |
| **经销商** | Reseller | B2B交易的核心参与者，支付业务的主要执行者和责任主体 |
| **关联订单** | Related Order | 连接订单上下文与支付上下文的重要业务关联 |

#### 金额和财务概念 (Amount and Financial Concepts)
| 中文术语 | 英文术语 | 业务含义 |
|---------|----------|----------|
| **支付金额** | Payment Amount | 支付义务的总额度，确定支付单的完成目标 |
| **已支付金额** | Paid Amount | 反映支付进度，用于判断支付完成度和计算剩余金额 |
| **已退款金额** | Refunded Amount | 记录退款历史，用于计算实际收款金额 |
| **实际收款金额** | Actual Amount | 真实的资金收入，财务核算的重要依据 |
| **待支付金额** | Pending Amount | 指导后续支付计划，确定支付是否完成的关键指标 |

#### 业务流程概念 (Business Process Concepts)
| 中文术语 | 英文术语 | 流程意义 |
|---------|----------|----------|
| **合并支付** | Batch Payment | 提高支付效率，降低手续费成本，简化企业财务处理流程 |
| **部分支付** | Partial Payment | 适应企业资金安排，支持灵活的支付计划，降低单次支付压力 |
| **支付回调** | Payment Callback | 确保支付结果的及时同步，保证系统状态与实际支付状态的一致性 |
| **退款执行** | Refund Execution | 区分退款审批（订单系统职责）和退款执行（支付系统职责） |
| **支付通知** | Payment Notification | 确保系统间数据一致性，支持业务流程的自动化推进 |

#### 状态枚举术语 (State Enumeration Terms)
| 状态类别 | 状态值 | 英文状态 | 业务含义 |
|----------|--------|----------|----------|
| **支付状态** | 未支付 | UNPAID | 支付单刚创建，尚未开始支付操作的初始状态 |
| **支付状态** | 支付中 | PAYING | 支付请求已发起，等待支付渠道确认结果的过程状态 |
| **支付状态** | 部分支付 | PARTIAL_PAID | 支付单已支付部分金额，仍有余额待支付的中间状态 |
| **支付状态** | 已支付 | PAID | 支付单全额支付完成的终态 |
| **退款状态** | 未退款 | NO_REFUND | 支付单未发生任何退款操作的初始状态 |
| **退款状态** | 部分退款 | PARTIAL_REFUNDED | 支付单已发生部分退款，仍有金额未退款的中间状态 |
| **退款状态** | 全额退款 | FULL_REFUNDED | 支付单已全额退款完成的终态 |

### 上下文边界与外部集成 (Context Boundaries and External Integration)

#### 与订单系统(Order System)的关系
- **关系模式**: Customer-Supplier (客户方-供应方)
- **集成方式**: REST API + Domain Events
- **数据交换**: 
  - 接收：支付单创建请求、退款执行指令、支付单信息更新
  - 发送：支付结果通知、支付状态变更事件、支付流水查询
- **依赖方向**: Payment Context 为 Order System 的供应方
- **术语映射**: 订单号 ↔ 关联订单、退款单号 ↔ 退款执行指令

#### 与财务系统(Financial System)的关系
- **关系模式**: Open Host Service (开放主机服务)
- **集成方式**: Message Queue + REST API
- **数据交换**: 
  - 发送：支付流水同步、退款流水同步、对账数据
  - 提供：日常对账接口、退款对账接口
- **依赖方向**: Financial System 通过标准接口访问支付数据
- **术语映射**: 支付流水 ↔ 财务记账、对账管理 ↔ 财务对账

#### 与信用管理系统(Credit Management System)的关系
- **关系模式**: Partnership (合作伙伴)
- **集成方式**: REST API + Domain Events
- **数据交换**: 
  - 接收：信用还款支付单创建请求、信用额度查询
  - 发送：还款结果通知、还款支付单状态更新
- **依赖方向**: 双向协作，共同支持信用支付业务
- **术语映射**: 信用还款 ↔ 还款支付单、关联业务 ↔ 信用记录

#### 与用户系统(User System)的关系
- **关系模式**: Conformist (遵循者)
- **集成方式**: REST API
- **数据交换**: 
  - 查询：经销商信息验证、支付权限验证
- **依赖方向**: Payment Context 依赖 User System
- **术语映射**: 企业用户 ↔ 经销商、用户权限 ↔ 支付权限

#### 与外部支付渠道(External Payment Channels)的关系
- **关系模式**: Anti-Corruption Layer (防腐层)
- **集成方式**: REST API + Webhook
- **数据交换**: 
  - 发送：支付请求、退款请求、支付状态查询
  - 接收：支付回调、退款回调、交易号
- **防腐策略**: 通过适配器模式统一不同支付渠道接口
- **术语映射**: Payment Channel ↔ 第三方支付平台、Transaction Number ↔ 交易号

### 技术架构约束 (Technical Architecture Constraints)
| 约束类别 | 具体要求 | 技术实现 |
|----------|----------|----------|
| **数据一致性** | 支付数据必须保证强一致性 | ACID事务、数据库约束 |
| **操作幂等性** | 支付接口需要幂等性保证 | 幂等键机制、状态校验 |
| **安全加密** | 支付敏感信息需要加密存储 | 字段级加密、传输加密 |
| **回调验证** | 支付回调需要签名验证 | 签名算法、防篡改机制 |
| **审计追踪** | 支付流水需要完整审计日志 | 审计字段、操作日志 |
| **性能要求** | 支持高并发支付处理 | 缓存机制、异步处理 |

### 业务规则约束 (Business Rules Constraints)
| 规则类别 | 业务约束 | 实现规则 |
|----------|----------|----------|
| **金额约束** | 支付金额必须大于0，已支付金额不能超过支付金额 | 聚合根内业务规则验证 |
| **退款约束** | 已退款金额不能超过已支付金额 | 退款执行前业务规则校验 |
| **状态约束** | 支付状态和退款状态变更必须符合状态机规则 | 状态转换规则引擎 |
| **B2B约束** | 大额支付需要特殊处理流程，支持长时间异步确认 | 异步状态管理、超时处理 |
| **合并约束** | 合并支付的支付单必须属于同一经销商 | 合并规则校验机制 |
| **信用约束** | 信用还款必须关联有效的信用记录 | 关联业务验证规则 |

### 业务能力边界 (Business Capability Boundaries)
#### 核心能力 (Core Capabilities)
- **支付单聚合根管理**: 支付单的创建、状态管理、金额计算
- **交易流水管理**: 支付和退款操作的详细记录和状态跟踪
- **支付渠道适配**: 统一的支付渠道接入和防腐处理
- **状态机管理**: 支付和退款状态的合法转换控制

#### 支撑能力 (Supporting Capabilities)  
- **金额一致性保证**: 支付、退款、实际收款金额的准确计算
- **业务规则引擎**: 支付和退款操作的业务规则验证
- **异常处理机制**: 支付异常、网络故障的恢复处理
- **审计日志服务**: 完整的操作记录和追踪能力

---

## 术语一致性声明 (Terminology Consistency Statement)

本上下文设计严格遵循《全局词汇表 v2.0》中的术语定义：
- ✅ 所有核心业务术语与全局词汇表保持一致
- ✅ 状态枚举术语使用标准定义的英文值和中文描述
- ✅ 业务流程术语符合词汇表中的业务含义说明
- ✅ 与外部系统集成时保持术语映射的准确性

**术语基准版本**: 全局词汇表 v2.0 (2025-09-26)
**下次术语同步**: 跟随全局词汇表更新
```