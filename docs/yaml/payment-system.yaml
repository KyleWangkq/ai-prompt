parentRoot: com.bytz
businessName: "PaymentSystem"
db:
  generateMapperXml: true
  useSoftDelete: true
  auditFields: [createTime, createBy, updateTime, updateBy]
aggregates:
  - name: PaymentAggregate
    table: cms_payment
    aggregateRoot: Payment
    entities:
      - name: Payment
        fields:
          - name: id
            type: String
            dbColumn: id
            pk: true
            comment: "支付单号，主键"
            constraints: [not null, length=32]
          - name: orderId
            type: String
            dbColumn: order_id
            pk: false
            comment: "关联订单号"
            constraints: [not null, length=32]
          - name: resellerId
            type: String
            dbColumn: reseller_id
            pk: false
            comment: "经销商ID"
            constraints: [not null, length=32]
          - name: paymentAmount
            type: BigDecimal
            dbColumn: payment_amount
            pk: false
            comment: "支付金额，固定使用人民币"
            constraints: [not null, precision=20, scale=6]
          - name: paidAmount
            type: BigDecimal
            dbColumn: paid_amount
            pk: false
            comment: "已支付金额，默认0"
            constraints: [not null, precision=20, scale=6]
          - name: refundedAmount
            type: BigDecimal
            dbColumn: refunded_amount
            pk: false
            comment: "已退款金额，默认0"
            constraints: [not null, precision=20, scale=6]
          - name: actualAmount
            type: BigDecimal
            dbColumn: actual_amount
            pk: false
            comment: "实际收款金额，计算属性 = paidAmount - refundedAmount"
            constraints: [not null, precision=20, scale=6]
          - name: paymentType
            type: String
            dbColumn: payment_type
            pk: false
            comment: "支付类型：ADVANCE_PAYMENT/FINAL_PAYMENT/OTHER_FEE/CREDIT_REPAYMENT"
            constraints: [not null, length=32]
          - name: paymentStatus
            type: String
            dbColumn: payment_status
            pk: false
            comment: "支付状态：UNPAID/PAYING/PARTIAL_PAID/PAID/FAILED/STOPPED/FROZEN"
            constraints: [not null, length=32]
          - name: refundStatus
            type: String
            dbColumn: refund_status
            pk: false
            comment: "退款状态：NO_REFUND/REFUNDING/PARTIAL_REFUNDED/FULL_REFUNDED/REFUND_FAILED"
            constraints: [not null, length=32]
          - name: businessDesc
            type: String
            dbColumn: business_desc
            pk: false
            comment: "业务描述，可选"
            constraints: [length=500]
          - name: paymentDeadline
            type: LocalDateTime
            dbColumn: payment_deadline
            pk: false
            comment: "支付截止时间，可选"
          - name: priorityLevel
            type: Integer
            dbColumn: priority_level
            pk: false
            comment: "优先级：1-高，2-中，3-低"
            constraints: [not null]
          - name: relatedBusinessId
            type: String
            dbColumn: related_business_id
            pk: false
            comment: "关联业务ID，支持信用记录、提货单等"
            constraints: [length=32]
          - name: relatedBusinessType
            type: String
            dbColumn: related_business_type
            pk: false
            comment: "关联业务类型，如CREDIT_RECORD"
            constraints: [length=32]
          - name: businessExpireDate
            type: LocalDateTime
            dbColumn: business_expire_date
            pk: false
            comment: "业务到期日，如信用还款到期日"
          - name: businessTags
            type: String
            dbColumn: business_tags
            pk: false
            comment: "业务标签，JSON格式"
            constraints: [length=1000]
          - name: createTime
            type: LocalDateTime
            dbColumn: create_time
            pk: false
            comment: "创建时间"
            constraints: [not null]
          - name: updateTime
            type: LocalDateTime
            dbColumn: update_time
            pk: false
            comment: "更新时间"
            constraints: [not null]
          - name: createBy
            type: String
            dbColumn: create_by
            pk: false
            comment: "创建人ID"
            constraints: [not null, length=32]
          - name: createByName
            type: String
            dbColumn: create_by_name
            pk: false
            comment: "创建人姓名"
            constraints: [not null, length=64]
          - name: updateBy
            type: String
            dbColumn: update_by
            pk: false
            comment: "更新人ID"
            constraints: [not null, length=32]
          - name: updateByName
            type: String
            dbColumn: update_by_name
            pk: false
            comment: "更新人姓名"
            constraints: [not null, length=64]
          - name: delFlag
            type: Integer
            dbColumn: del_flag
            pk: false
            comment: "删除标识，0-正常，1-删除"
            constraints: [not null]
      - name: PaymentTransaction
        table: cms_payment_transaction
        fields:
          - name: id
            type: String
            dbColumn: id
            pk: true
            comment: "流水号，主键"
            constraints: [not null, length=32]
          - name: paymentId
            type: String
            dbColumn: payment_id
            pk: false
            comment: "关联支付单号"
            constraints: [not null, length=32]
          - name: transactionType
            type: String
            dbColumn: transaction_type
            pk: false
            comment: "流水类型：PAYMENT/REFUND"
            constraints: [not null, length=16]
          - name: transactionStatus
            type: String
            dbColumn: transaction_status
            pk: false
            comment: "流水状态：PROCESSING/SUCCESS/FAILED"
            constraints: [not null, length=16]
          - name: transactionAmount
            type: BigDecimal
            dbColumn: transaction_amount
            pk: false
            comment: "交易金额，支付为正数，退款为负数，固定使用人民币"
            constraints: [not null, precision=20, scale=6]
          - name: paymentChannel
            type: String
            dbColumn: payment_channel
            pk: false
            comment: "支付渠道：ONLINE_PAYMENT/WALLET_PAYMENT/WIRE_TRANSFER/CREDIT_ACCOUNT"
            constraints: [not null, length=32]
          - name: channelTransactionNumber
            type: String
            dbColumn: channel_transaction_number
            pk: false
            comment: "渠道交易号，可选"
            constraints: [length=64]
          - name: paymentWay
            type: String
            dbColumn: payment_way
            pk: false
            comment: "支付方式，具体的支付方式"
            constraints: [length=32]
          - name: originalTransactionId
            type: String
            dbColumn: original_transaction_id
            pk: false
            comment: "原流水号，退款时关联的原支付流水号"
            constraints: [length=32]
          - name: businessOrderId
            type: String
            dbColumn: business_order_id
            pk: false
            comment: "业务单号，如退款单号"
            constraints: [length=32]
          - name: createTime
            type: LocalDateTime
            dbColumn: create_time
            pk: false
            comment: "流水记录创建时间"
            constraints: [not null]
          - name: completeDatetime
            type: LocalDateTime
            dbColumn: complete_datetime
            pk: false
            comment: "交易完成时间，可选"
          - name: expirationTime
            type: LocalDateTime
            dbColumn: expiration_time
            pk: false
            comment: "支付过期时间，可选"
          - name: delFlag
            type: Integer
            dbColumn: del_flag
            pk: false
            comment: "删除标识，0-正常，1-删除"
            constraints: [not null]
          - name: createBy
            type: String
            dbColumn: create_by
            pk: false
            comment: "创建人ID"
            constraints: [not null, length=32]
          - name: createByName
            type: String
            dbColumn: create_by_name
            pk: false
            comment: "创建人姓名"
            constraints: [not null, length=64]
          - name: updateBy
            type: String
            dbColumn: update_by
            pk: false
            comment: "更新人ID"
            constraints: [not null, length=32]
          - name: updateByName
            type: String
            dbColumn: update_by_name
            pk: false
            comment: "更新人姓名"
            constraints: [not null, length=64]
          - name: updateTime
            type: LocalDateTime
            dbColumn: update_time
            pk: false
            comment: "最后更新时间"
            constraints: [not null]
          - name: remark
            type: String
            dbColumn: remark
            pk: false
            comment: "业务备注，交易备注信息"
            constraints: [length=500]
    valueObjects:
      - name: PaymentChannel
        fields:
          - name: channelCode
            type: String
            dbColumn: channel_code
            pk: false
            comment: "支付渠道代码"
          - name: channelName
            type: String
            dbColumn: channel_name
            pk: false
            comment: "支付渠道名称"
          - name: channelType
            type: String
            dbColumn: channel_type
            pk: false
            comment: "渠道分类"
          - name: supportRefund
            type: Boolean
            dbColumn: support_refund
            pk: false
            comment: "是否支持退款"
          - name: minAmount
            type: BigDecimal
            dbColumn: min_amount
            pk: false
            comment: "最小金额限制"
          - name: maxAmount
            type: BigDecimal
            dbColumn: max_amount
            pk: false
            comment: "最大金额限制"
      - name: PaymentId
        fields:
          - name: value
            type: String
            dbColumn: value
            pk: false
            comment: "支付单ID字符串，32位唯一标识"
      - name: RelatedBusinessInfo
        fields:
          - name: businessId
            type: String
            dbColumn: business_id
            pk: false
            comment: "关联的业务记录标识，如信用记录ID、提货单ID"
          - name: businessType
            type: String
            dbColumn: business_type
            pk: false
            comment: "关联业务类型"
          - name: expireDate
            type: LocalDateTime
            dbColumn: expire_date
            pk: false
            comment: "业务相关的到期日期，可选"
      - name: BusinessTags
        fields:
          - name: tags
            type: String
            dbColumn: tags
            pk: false
            comment: "标签键值对集合，JSON格式"
    repository:
      interface: IPaymentRepository
      extends: IService<Payment>
      methods:
        - signature: "save(payment: Payment): Payment"
        - signature: "findById(id: PaymentId): Optional<Payment>"
        - signature: "delete(payment: Payment): void"
        - signature: "exists(id: PaymentId): Boolean"
        - signature: "findByOrderId(orderId: OrderId): List<Payment>"
        - signature: "findByResellerId(resellerId: ResellerId): List<Payment>"
        - signature: "findByPaymentStatus(status: PaymentStatus): List<Payment>"
        - signature: "findByPaymentType(type: PaymentType): List<Payment>"
        - signature: "findByRelatedBusiness(businessType: RelatedBusinessType, businessId: String): List<Payment>"
        - signature: "findByAmountRange(minAmount: BigDecimal, maxAmount: BigDecimal): List<Payment>"
        - signature: "findByDateRange(startDate: DateTime, endDate: DateTime): List<Payment>"
        - signature: "findByDeadlineBefore(deadline: DateTime): List<Payment>"
        - signature: "findUnpaidOrPartialPaid(resellerId: ResellerId): List<Payment>"
        - signature: "findPendingRefund(): List<Payment>"
        - signature: "saveAll(payments: List<Payment>): List<Payment>"
        - signature: "findByIds(ids: List<PaymentId>): List<Payment>"
        - signature: "countByStatus(status: PaymentStatus): Long"
        - signature: "sumAmountByDateRange(startDate: DateTime, endDate: DateTime): BigDecimal"
        - signature: "countByPaymentTypeAndStatus(type: PaymentType, status: PaymentStatus): Long"
        - signature: "findTopResellersByAmount(limit: Integer): List<ResellerPaymentSummary>"
        - signature: "findWithTransactions(id: PaymentId): Optional<Payment>"
        - signature: "findSummaryById(id: PaymentId): Optional<PaymentSummary>"
    domainServices:
      - PaymentExecutionService
      - PaymentValidationService
      - PaymentAmountCalculationService
      - PaymentReconciliationService
    events:
      - PaymentCreated
      - PaymentExecuted
      - PaymentStatusChanged
      - RefundExecuted
      - CreditRepaymentCompleted
      - BatchPaymentCompleted
  - name: TransactionAggregate
    table: cms_payment_transaction_repository
    aggregateRoot: TransactionRepository
    entities:
      - name: TransactionRepository
        fields:
          - name: id
            type: String
            dbColumn: id
            pk: true
            comment: "交易流水仓储标识"
            constraints: [not null, length=32]
    repository:
      interface: ITransactionRepository
      extends: IService<PaymentTransaction>
      methods:
        - signature: "findByPaymentId(paymentId: PaymentId): List<PaymentTransaction>"
        - signature: "findByChannelTransactionNumber(transactionNumber: String): Optional<PaymentTransaction>"
        - signature: "findByTransactionType(type: TransactionType): List<PaymentTransaction>"
        - signature: "findRefundableTransactions(paymentId: PaymentId): List<PaymentTransaction>"
        - signature: "findByDateRangeAndChannel(startDate: DateTime, endDate: DateTime, channel: PaymentChannel): List<PaymentTransaction>"
        - signature: "findUnreconciledTransactions(reconcileDate: DateTime): List<PaymentTransaction>"
globalBehaviors: []