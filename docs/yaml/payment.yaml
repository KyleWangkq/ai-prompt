parentRoot: com.bytz
businessName: "Payment"
db:
  generateMapperXml: true
  useSoftDelete: true
  auditFields: [createTime, createBy, updateTime, updateBy]
aggregates:
  - name: PaymentAggregate
    table: t_payment
    aggregateRoot: Payment
    entities:
      - name: Payment
        fields:
          - name: id
            type: String
            dbColumn: id
            pk: true
            comment: "支付单号，主键，32位"
            constraints: [not null, length=32]
          - name: orderId
            type: String
            dbColumn: order_id
            pk: false
            comment: "关联订单号"
            constraints: [not null]
          - name: resellerId
            type: String
            dbColumn: reseller_id
            pk: false
            comment: "经销商ID"
            constraints: [not null]
          - name: paymentAmount
            type: BigDecimal
            dbColumn: payment_amount
            pk: false
            comment: "支付金额，固定使用人民币"
            constraints: [not null]
          - name: paidAmount
            type: BigDecimal
            dbColumn: paid_amount
            pk: false
            comment: "已支付金额，默认0"
            constraints: [not null]
          - name: refundedAmount
            type: BigDecimal
            dbColumn: refunded_amount
            pk: false
            comment: "已退款金额，默认0"
            constraints: [not null]
          - name: actualAmount
            type: BigDecimal
            dbColumn: actual_amount
            pk: false
            comment: "实际收款金额，计算属性 = paidAmount - refundedAmount"
          - name: paymentType
            type: String
            dbColumn: payment_type
            pk: false
            comment: "支付类型：预付款/尾款/其他费用/信用还款"
            constraints: [not null]
          - name: paymentStatus
            type: String
            dbColumn: payment_status
            pk: false
            comment: "支付状态"
            constraints: [not null]
          - name: refundStatus
            type: String
            dbColumn: refund_status
            pk: false
            comment: "退款状态，默认NO_REFUND"
            constraints: [not null]
          - name: businessDesc
            type: String
            dbColumn: business_desc
            pk: false
            comment: "业务描述"
          - name: paymentDeadline
            type: LocalDateTime
            dbColumn: payment_deadline
            pk: false
            comment: "支付截止时间"
          - name: priorityLevel
            type: Integer
            dbColumn: priority_level
            pk: false
            comment: "优先级：1-高，2-中，3-低"
            constraints: [not null]
          - name: relatedBusinessId
            type: String
            dbColumn: related_business_id
            pk: false
            comment: "关联业务ID，支持信用记录、提货单等"
          - name: relatedBusinessType
            type: String
            dbColumn: related_business_type
            pk: false
            comment: "关联业务类型，如CREDIT_RECORD"
          - name: businessExpireDate
            type: LocalDateTime
            dbColumn: business_expire_date
            pk: false
            comment: "业务到期日，如信用还款到期日"
          - name: businessTags
            type: String
            dbColumn: business_tags
            pk: false
            comment: "业务标签，JSON格式"
          - name: createTime
            type: LocalDateTime
            dbColumn: create_time
            pk: false
            comment: "创建时间"
            constraints: [not null]
          - name: updateTime
            type: LocalDateTime
            dbColumn: update_time
            pk: false
            comment: "更新时间"
            constraints: [not null]
          - name: createBy
            type: String
            dbColumn: create_by
            pk: false
            comment: "创建人ID"
            constraints: [not null]
          - name: createByName
            type: String
            dbColumn: create_by_name
            pk: false
            comment: "创建人姓名"
          - name: updateBy
            type: String
            dbColumn: update_by
            pk: false
            comment: "更新人ID"
          - name: updateByName
            type: String
            dbColumn: update_by_name
            pk: false
            comment: "更新人姓名"
          - name: delFlag
            type: Integer
            dbColumn: del_flag
            pk: false
            comment: "删除标识，0-正常，1-删除"
            constraints: [not null]
      - name: PaymentTransaction
        fields:
          - name: id
            type: String
            dbColumn: id
            pk: true
            comment: "流水号，主键，32位"
            constraints: [not null, length=32]
          - name: paymentId
            type: String
            dbColumn: payment_id
            pk: false
            comment: "关联支付单号"
            constraints: [not null]
          - name: transactionType
            type: String
            dbColumn: transaction_type
            pk: false
            comment: "流水类型：支付/退款"
            constraints: [not null]
          - name: transactionStatus
            type: String
            dbColumn: transaction_status
            pk: false
            comment: "流水状态：处理中/成功/失败"
            constraints: [not null]
          - name: transactionAmount
            type: BigDecimal
            dbColumn: transaction_amount
            pk: false
            comment: "交易金额，支付为正数，退款为负数，固定使用人民币"
            constraints: [not null]
          - name: paymentChannel
            type: String
            dbColumn: payment_channel
            pk: false
            comment: "支付渠道：线上支付/钱包支付/电汇支付/信用账户"
            constraints: [not null]
          - name: channelTransactionNumber
            type: String
            dbColumn: channel_transaction_number
            pk: false
            comment: "渠道交易号"
          - name: paymentWay
            type: String
            dbColumn: payment_way
            pk: false
            comment: "支付方式"
          - name: originalTransactionId
            type: String
            dbColumn: original_transaction_id
            pk: false
            comment: "原流水号，退款时关联的原支付流水号"
          - name: businessOrderId
            type: String
            dbColumn: business_order_id
            pk: false
            comment: "业务单号，如退款单号"
          - name: createTime
            type: LocalDateTime
            dbColumn: create_time
            pk: false
            comment: "流水记录创建时间"
            constraints: [not null]
          - name: completeDatetime
            type: LocalDateTime
            dbColumn: complete_datetime
            pk: false
            comment: "交易完成时间"
          - name: expirationTime
            type: LocalDateTime
            dbColumn: expiration_time
            pk: false
            comment: "支付过期时间"
          - name: delFlag
            type: Integer
            dbColumn: del_flag
            pk: false
            comment: "删除标识，0-正常，1-删除"
            constraints: [not null]
          - name: createBy
            type: String
            dbColumn: create_by
            pk: false
            comment: "创建人ID"
          - name: createByName
            type: String
            dbColumn: create_by_name
            pk: false
            comment: "创建人姓名"
          - name: updateBy
            type: String
            dbColumn: update_by
            pk: false
            comment: "更新人ID"
          - name: updateByName
            type: String
            dbColumn: update_by_name
            pk: false
            comment: "更新人姓名"
          - name: updateTime
            type: LocalDateTime
            dbColumn: update_time
            pk: false
            comment: "最后更新时间"
          - name: remark
            type: String
            dbColumn: remark
            pk: false
            comment: "业务备注，交易备注信息"
    valueObjects:
      - name: PaymentChannel
        fields:
          - name: channelCode
            type: String
            dbColumn: channel_code
            pk: false
            comment: "渠道代码"
          - name: channelName
            type: String
            dbColumn: channel_name
            pk: false
            comment: "渠道名称"
          - name: channelType
            type: String
            dbColumn: channel_type
            pk: false
            comment: "渠道类型"
          - name: supportRefund
            type: Boolean
            dbColumn: support_refund
            pk: false
            comment: "是否支持退款"
          - name: minAmount
            type: BigDecimal
            dbColumn: min_amount
            pk: false
            comment: "最小金额"
          - name: maxAmount
            type: BigDecimal
            dbColumn: max_amount
            pk: false
            comment: "最大金额"
      - name: RelatedBusinessInfo
        fields:
          - name: businessId
            type: String
            dbColumn: business_id
            pk: false
            comment: "业务ID"
          - name: businessType
            type: String
            dbColumn: business_type
            pk: false
            comment: "业务类型"
          - name: businessDesc
            type: String
            dbColumn: business_desc
            pk: false
            comment: "业务描述"
          - name: expireDate
            type: LocalDateTime
            dbColumn: expire_date
            pk: false
            comment: "业务到期日期"
      - name: PaymentId
        fields:
          - name: value
            type: String
            dbColumn: value
            pk: false
            comment: "支付单ID值"
      - name: BusinessTags
        fields:
          - name: tags
            type: String
            dbColumn: tags
            pk: false
            comment: "标签JSON格式"
    repository:
      interface: PaymentRepository
      extends: IService<Payment>
      methods:
        - signature: "save(payment: Payment): Payment"
        - signature: "findById(id: PaymentId): Optional<Payment>"
        - signature: "delete(payment: Payment): void"
        - signature: "exists(id: PaymentId): Boolean"
        - signature: "findByOrderId(orderId: OrderId): List<Payment>"
        - signature: "findByResellerId(resellerId: ResellerId): List<Payment>"
        - signature: "findByPaymentStatus(status: PaymentStatus): List<Payment>"
        - signature: "findByPaymentType(type: PaymentType): List<Payment>"
        - signature: "findByRelatedBusiness(businessType: RelatedBusinessType, businessId: String): List<Payment>"
        - signature: "findByAmountRange(minAmount: BigDecimal, maxAmount: BigDecimal): List<Payment>"
        - signature: "findByDateRange(startDate: DateTime, endDate: DateTime): List<Payment>"
        - signature: "findByDeadlineBefore(deadline: DateTime): List<Payment>"
        - signature: "findUnpaidOrPartialPaid(resellerId: ResellerId): List<Payment>"
        - signature: "findPendingRefund(): List<Payment>"
        - signature: "saveAll(payments: List<Payment>): List<Payment>"
        - signature: "findByIds(ids: List<PaymentId>): List<Payment>"
        - signature: "countByStatus(status: PaymentStatus): Long"
        - signature: "sumAmountByDateRange(startDate: DateTime, endDate: DateTime): BigDecimal"
        - signature: "countByPaymentTypeAndStatus(type: PaymentType, status: PaymentStatus): Long"
        - signature: "findTopResellersByAmount(limit: Integer): List<ResellerPaymentSummary>"
        - signature: "findWithTransactions(id: PaymentId): Optional<Payment>"
        - signature: "findSummaryById(id: PaymentId): Optional<PaymentSummary>"
    domainServices:
      - PaymentExecutionService
      - PaymentValidationService
      - PaymentAmountCalculationService
      - PaymentCalculationService
      - PaymentReconciliationService
    events:
      - PaymentCreated
      - PaymentExecuted
      - PaymentStatusChanged
      - RefundExecuted
      - CreditRepaymentCompleted
      - BatchPaymentCompleted
  - name: TransactionAggregate
    table: t_payment_transaction
    aggregateRoot: PaymentTransaction
    entities:
      - name: PaymentTransaction
        fields:
          - name: id
            type: String
            dbColumn: id
            pk: true
            comment: "流水号，主键"
            constraints: [not null]
          - name: paymentId
            type: String
            dbColumn: payment_id
            pk: false
            comment: "关联支付单号"
            constraints: [not null]
    repository:
      interface: TransactionRepository
      extends: IService<PaymentTransaction>
      methods:
        - signature: "findByPaymentId(paymentId: PaymentId): List<PaymentTransaction>"
        - signature: "findByChannelTransactionNumber(transactionNumber: String): Optional<PaymentTransaction>"
        - signature: "findByTransactionType(type: TransactionType): List<PaymentTransaction>"
        - signature: "findRefundableTransactions(paymentId: PaymentId): List<PaymentTransaction>"
globalBehaviors: []
