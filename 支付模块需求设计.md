# 支付模块需求设计文档

## 文档信息
| 项目 | 内容 |
|------|------|
| **文档名称** | 支付模块需求设计文档 |
| **项目名称** | 企业间特种设备定制交易系统 - 支付模块 |
| **文档版本** | v1.4 |
| **创建日期** | 2025年9月27日 |
| **文档状态** | 修订版 |
| **作者** | 产品团队 |
| **审核人** | 技术负责人 |
| **批准人** | 项目经理 |

## 目录
- [1. 概述](#1-概述)
  - [1.1 项目背景](#11-项目背景)
  - [1.2 项目目标](#12-项目目标)
- [2. 项目范围](#2-项目范围)
  - [2.1 功能边界](#21-功能边界)
  - [2.2 业务场景覆盖](#22-业务场景覆盖)
- [3. 术语定义](#3-术语定义)
- [4. 功能需求](#4-功能需求)
- [5. 非功能需求](#5-非功能需求)
- [6. 约束条件](#6-约束条件)
- [7. 附录](#7-附录)

## 1. 概述

### 1.1 项目背景

本支付模块是企业间特种设备定制交易系统的核心组成部分，专门负责处理B2B定制化设备交易中的支付功能。支付系统主要与订单系统进行交互，响应订单状态变化并处理相应的支付需求。

**业务背景特点**：
- **大额交易特征**：企业间交易金额通常较大，需要特殊的支付处理机制
- **生产周期长**：定制化设备生产周期较长，支持分阶段支付模式
- **复合订单支持**：支持多商品类型和数量的复合订单统一支付
- **灵活支付机制**：支持灵活的预付比例和超额支付处理
- **系统协同**：与订单系统紧密配合，提供完整的支付服务链路

### 1.2 项目目标

本支付模块旨在为企业间特种设备定制交易系统提供完整的支付解决方案。

#### 1.2.1 核心业务目标
- 提供适应B2B特种设备交易的分阶段支付解决方案
- 响应订单系统的业务需求，提供预付款、尾款等支付服务  
- 实现多订单合并支付和多渠道分次支付功能
- 支持灵活的支付金额配置和支付时间安排

#### 1.2.2 技术目标
- 保证大额支付过程的安全性与合规性
- 提供完整的支付状态查询、退款、对账和还款等功能
- 建立稳定可靠的支付系统架构，确保高可用性
- 实现与多种支付渠道的无缝集成

#### 1.2.3 用户体验目标
- 简化企业用户的支付操作流程
- 提供实时的支付状态反馈和查询功能
- 支持灵活的支付方式选择
- 提供直观的支付进度和状态展示
## 2. 项目范围

### 2.1 功能边界

支付模块将专注于支付相关功能，与其他系统模块明确分工。

#### 2.1.1 包含的功能
| 功能模块 | 具体功能 |
|----------|----------|
| **支付单管理** | 支付单创建、状态跟踪、生命周期管理 |
| **支付渠道管理** | 支付渠道集成|
| **支付执行** | 支付请求处理、结果处理、回调处理 |
| **退款执行** | 接收退款指令、选择支付流水、执行退款操作 |
| **对账管理** | 日常对账、差异处理、报表生成 |
| **监控报警** | 支付监控、异常报警、性能统计 |

#### 2.1.2 不包含的功能
| 功能模块 | 负责系统 | 说明 |
|----------|----------|------|
| **订单管理** | 订单系统 | 订单创建、状态管理、生产流程 |
| **退款审批** | 订单系统 | 退款申请、业务审核、审批流程 |
| **用户管理** | 用户系统 | 用户认证、权限管理、企业信息 |
| **商品管理** | 商品系统 | 商品信息、价格管理、库存管理 |
| **财务核算** | 财务系统 | 会计处理、财务报告、税务管理 |
| **信用管理** | 信用管理系统 | 信用评估、额度审批、还款计划制定、逾期管理 |

### 2.2 业务场景覆盖

#### 2.2.1 核心支付场景
| 场景类别 | 具体场景 | 说明 |
|----------|----------|------|
| **支付单处理** | 支付单创建与管理 | 接收订单系统创建的支付单，生成唯一支付单号 |
| **统一支付处理** | 支付单批量处理 | 统一处理单个或多个支付单，支持全额或部分金额支付 |
| **合并支付** | 多支付单合并支付 | 多个支付单使用同一支付渠道合并处理 |
| **分批支付** | 支付单多次分批 | 支持一个支付单分多次完成支付 |
| **状态管理** | 支付全生命周期 | 从创建到完成的完整状态跟踪 |
| **结果通知** | 支付结果反馈 | 及时通知订单系统支付处理结果 |

#### 2.2.2 支付渠道接入
| 渠道类型 | 具体渠道 | 特点 |
|----------|----------|------|
| **线上支付** | 银联、网银等 | B端大额支付，确认时限较长 |
| **钱包支付** | 企业寄存资金 | 企业内部资金管理 |
| **电汇支付** | 银行转账 | 传统转账方式，需要凭证确认 |
| **信用账户** | 企业信用额度 | 基于信用的延期付款 |

#### 2.2.3 支付管理功能
| 功能分类 | 具体功能 | 业务价值 |
|----------|----------|----------|
| **结果处理** | 支付回调与通知 | 处理长时间异步确认 |
| **异常管理** | 退款与异常处理 | 保障资金安全 |
| **多类型支付** | 预付款、尾款、信用还款统一处理 | 支持多种支付场景的统一管理 |
| **财务对接** | 支付日志与对账 | 确保财务数据准确性 |
| **进度跟踪** | 分阶段支付监控 | 配合生产进度管理 |
## 3. 术语定义

### 3.1 基础概念

| 术语 | 英文 | 定义 |
|------|------|------|
| **支付渠道** | Payment Channel | 银联等第三方支付服务商，以及企业内部支付管理模块 |
| **支付单** | Payment | 系统内生成的支付请求记录，由支付模块生成唯一支付单号 |
| **支付单号** | Payment ID | 由支付模块管理和生成的唯一流水号 |
| **交易号** | Transaction ID | 支付渠道返回的唯一交易编号 |
| **回调** | Callback/Notify | 支付渠道在支付完成后异步通知系统的机制 |

### 3.2 业务特定术语

| 术语 | 英文 | 定义 |
|------|------|------|
| **经销商ID** | Reseller ID | 支付方经销商的唯一标识 |
| **支付单类型** | Payment Type | 区分支付单的业务类型，如预付款、尾款、其他费用、信用还款等，可通过关联业务字段进一步明确具体业务场景 |
| **合并支付** | Batch Payment | 多个支付单选择一个支付渠道进行合并支付 |
| **部分支付** | Partial Payment | 支付单可以选择一个渠道支付部分金额，支持多次部分支付直到完成 |
| **已支付金额** | Paid Amount | 支付单已经支付的累计金额 |
| **待支付金额** | Pending Amount | 支付单还需要支付的剩余金额 |
| **信用支付** | Credit Payment | 使用企业信用额度进行的支付，产生还款义务 |
| **信用还款** | Credit Repayment | 企业对信用额度的还款操作，只是支付类型为"信用还款"的普通支付单，按统一支付流程处理 |
| **关联业务ID** | Related Business ID | 支付单关联的业务记录标识，支持不同业务场景的关联需求 |
| **关联业务类型** | Related Business Type | 标识关联业务的类型，如CREDIT_RECORD（信用记录）、DELIVERY_ORDER（提货单）等 |
| **信用额度** | Credit Limit | 企业可使用的信用支付上限，由信用管理模块维护 |

### 3.3 支付单状态定义

#### 3.3.1 支付状态

| 状态 | 英文 | 说明 |
|------|------|------|
| **未支付** | Unpaid | 支付单刚创建，尚未开始支付 |
| **支付中** | Paying | 支付请求已发起，等待支付渠道确认 |
| **部分支付** | Partial Paid | 支付单已支付部分金额，仍有余额待支付 |
| **已支付** | Paid | 支付单全额支付完成 |
| **支付失败** | Failed | 支付过程中出现错误，支付未成功 |
| **已停止** | Stopped | 因业务原因主动停止支付操作 |
| **已冻结** | Frozen | 支付单因特殊原因暂时无法操作 |

#### 3.3.2 退款状态

| 状态 | 英文 | 说明 |
|------|------|------|
| **未退款** | No Refund | 支付单未发生任何退款 |
| **退款中** | Refunding | 退款请求已发起，等待退款渠道确认 |
| **部分退款** | Partial Refunded | 支付单已发生部分退款，仍有金额未退款 |
| **全额退款** | Full Refunded | 支付单已全额退款 |
| **退款失败** | Refund Failed | 退款过程中出现错误，退款未成功 |

### 3.4 业务背景术语

| 术语 | 说明 |
|------|------|
| **生产排产** | 订单系统管理的生产计划安排 |
| **部分发货** | 订单系统管理的分批发货流程 |
| **预付款** | 订单确认后的首期付款 |
| **尾款** | 发货或完工后的最终付款 |
## 4. 功能需求

### 4.1 支付单管理

#### 4.1.1 支付单接收与创建
#### 4.1.1 支付单接收与创建

**支付单接收**：
接收订单系统创建的支付单请求，包含完整的支付信息：
  
| 信息类别 | 具体字段 | 必填 | 说明 |
|----------|----------|------|------|
| **基本信息** | 关联订单号 | ✓ | 对应的订单编号 |
| | 经销商ID | ✓ | 支付方经销商标识 |
| | 支付类型 | ✓ | 预付款、尾款、其他费用、信用还款 |
| **金额信息** | 支付金额 | ✓ | 由订单系统或信用管理模块计算确定（人民币） |
| **时间信息** | 支付截止时间 | ○ | 建议的支付完成时间 |
| **业务信息** | 业务备注 | ○ | 支付用途说明 |
| **关联业务信息** | 关联业务ID | ○ | 关联的业务记录标识（如信用记录ID、提货单ID等） |
| | 关联业务类型 | ○ | 关联业务的类型标识（如CREDIT_RECORD、DELIVERY_ORDER等） |
| | 业务到期日 | ○ | 业务相关的到期日期（如信用还款到期日、提货到期日等） |

**支付单验证与存储**：
- **数据验证**：检查支付单信息完整性和合法性
- **唯一性校验**：避免重复创建相同的支付单
- **金额校验**：验证支付金额的合理性
- **数据存储**：将支付单信息持久化到数据库
- **流水号生成**：生成系统唯一的支付单流水号
- **状态初始化**：支付单状态初始化为"未支付"
- **结果返回**：向订单系统返回支付单创建结果

### 4.2 支付执行流程

支付执行基于统一的批量处理架构，单支付单支付只是多支付单合并支付的一个特例，采用相同的处理流程。

#### 4.2.1 支付单选择与支付

**支付单选择**：
1. **支付单筛选**：客户从未支付完成的支付单中进行筛选
   - 支持单个或多个支付单选择（单支付单是特例情况）
   - 筛选条件：支付状态、支付类型、订单范围、金额范围、时间范围

2. **合并规则校验**：
   - 验证支付单是否属于同一经销商
   - 检查支付单状态是否允许支付

**支付执行（统一流程）**：
1. **支付渠道选择**：选择一个支付渠道进行支付
2. **支付金额分配**：
   - 显示每个支付单的待支付金额
   - 允许用户为每个支付单指定本次支付金额（单支付单时只有一个）
   - 系统计算总支付金额（所有参与支付单的金额之和）
   - 校验每个支付单的支付金额不超过其待支付金额
3. **支付操作**：
   - 调用支付渠道创建支付请求，金额为总支付金额
   - 支付渠道返回统一的支付渠道交易号
4. **支付流水记录**：
   - 为每个参与支付的支付单创建独立的支付流水记录
   - 每条支付流水记录包含：
     * 支付单号、支付金额（该支付单分配的金额）
     * 支付渠道、支付渠道交易号（同一个交易号）
   - 流水状态更新为"支付中"
5. **状态更新**：更新所有参与支付的支付单状态为"支付中"

**设计说明**：
- 单支付单支付作为多支付单合并支付的特例，使用同一套处理逻辑
- 简化了系统复杂度，减少了代码冗余
- 所有支付操作都遵循相同的数据流和状态管理机制

### 4.3 支付筛选与批量管理

#### 4.3.1 支付单筛选

**筛选条件**：
| 筛选维度 | 可选项 | 说明 |
|----------|--------|------|
| **支付单状态** | 未支付、部分支付 | 只能选择未完成支付的订单 |
| **支付类型** | 预付款、尾款、其他费用 | 按业务类型分类选择 |
| **订单范围** | 单个订单、多个订单 | 支持跨订单批量支付 |
| **金额范围** | 自定义金额区间 | 按金额大小筛选 |
| **时间范围** | 创建时间、截止时间 | 按时间维度筛选 |

**信息展示**：
- 支付单详细信息（金额、状态、截止时间等）
- 已支付金额和待支付金额
- 关联订单信息
- 支付历史记录

#### 4.3.2 批量支付执行

**统一支付策略**：
1. **同一渠道批量支付**
   - 选择同一支付渠道
   - 计算总支付金额
   - 执行统一支付操作（单支付单和多支付单均采用此方式）

2. **分次支付处理**
   - 支持对同一批支付单进行多次支付
   - 每次支付可选择不同的支付单组合
   - 灵活的支付金额分配

**操作特性**：
- 统一的支付处理流程，无论单个还是多个支付单
- 支持多次分批操作
- 实时状态更新和进度反馈

### 4.4 支付单数据模型

#### 4.4.0 数据库设计原则

基于现有系统表结构（`cms_order_pay`、`cms_order_pay_detail`）的命名风格，新支付模块表设计遵循以下原则：

**表命名规范**：
- **系统前缀**：使用`cms_`作为统一系统前缀
- **模块标识**：使用`payment_`标识支付模块
- **功能描述**：明确表达表的业务功能（如`order`表示支付单，`transaction`表示流水）
- **命名风格**：全小写字母，使用下划线分隔单词

**字段命名规范**：
- **主键字段**：统一使用`id`
- **关联字段**：使用`xxx_id`格式（如`order_id`、`payment_id`）
- **时间字段**：使用`_time`表示完整日期时间，`_date`表示日期
- **金额字段**：使用`_amount`后缀，数据类型为`decimal(20,6)`
- **状态字段**：直接使用`status`或带业务前缀（如`payment_status`）
- **系统字段**：保持与现有系统一致（如`del_flag`、`create_by`、`create_time`等）

**⚠️ 重要说明**：
- 本设计仅参考现有表结构的命名风格，不复用现有表的业务字段
- 支付模块专注于支付功能，已移除原表中的物流相关字段（如`ship_to_xxx`字段）
- 新增了信用支付、关联业务等新业务场景的支持字段

#### 4.4.1 核心数据结构

| 信息类别 | 业务字段名称 | 数据库字段名称 | 数据类型 | 必填 | 说明 |
|----------|-------------|---------------|----------|------|------|
| **基础信息** | 支付单号 | id | varchar(32) | ✓ | 系统唯一标识，主键 |
| | 关联订单号 | order_id | varchar(32) | ✓ | 对应的订单编号 |
| | 经销商ID | reseller_id | varchar(32) | ✓ | 支付方经销商标识 |
| | 创建时间 | create_time | datetime | ✓ | 支付单创建时间 |
| | 更新时间 | update_time | datetime | ✓ | 最后更新时间 |
| | 创建人 | create_by | varchar(32) | ○ | 创建人ID |
| | 创建人姓名 | create_by_name | varchar(32) | ○ | 创建人姓名 |
| | 更新人 | update_by | varchar(32) | ○ | 更新人ID |
| | 更新人姓名 | update_by_name | varchar(32) | ○ | 更新人姓名 |
| | 删除状态 | del_flag | int | ○ | 删除标识（0-正常，1-删除） |
| **支付信息** | 支付金额 | payment_amount | decimal(20,6) | ✓ | 支付单总金额 |
| | 已支付金额 | paid_amount | decimal(20,6) | ✓ | 累计已支付金额，默认0 |
| | 已退款金额 | refunded_amount | decimal(20,6) | ✓ | 累计已退款金额，默认0 |
| | 实际收款金额 | actual_amount | decimal(20,6) | ✓ | 已支付金额 - 已退款金额 |
| | 币种 | currency | varchar(3) | ✓ | 固定为CNY（人民币） |
| | 支付类型 | payment_type | varchar(20) | ✓ | 预付款/尾款/其他费用/信用还款 |
| | 支付状态 | payment_status | varchar(20) | ✓ | 当前支付状态 |
| | 退款状态 | refund_status | varchar(20) | ✓ | 当前退款状态 |
| **业务信息** | 业务描述 | business_desc | varchar(500) | ○ | 支付用途说明 |
| | 支付截止时间 | payment_deadline | datetime | ○ | 建议完成时间 |
| | 优先级 | priority_level | int | ○ | 支付优先级（1-高，2-中，3-低） |
| **关联业务信息** | 关联业务ID | related_business_id | varchar(32) | ○ | 关联的业务记录标识 |
| | 关联业务类型 | related_business_type | varchar(20) | ○ | 关联业务类型 |
| | 业务到期日 | business_expire_date | datetime | ○ | 业务相关的到期日期 |
| **扩展信息** | 业务标签 | business_tags | json | ○ | 相关业务标记 |

#### 4.4.2 支付流水表设计

**支付流水表**（整合支付和退款记录）：

| 信息类别 | 业务字段名称 | 数据库字段名称 | 数据类型 | 必填 | 说明 |
|----------|-------------|---------------|----------|------|------|
| **基础信息** | 流水号 | id | varchar(32) | ✓ | 系统唯一流水标识，主键 |
| | 支付单号 | payment_id | varchar(32) | ✓ | 关联的支付单号 |
| | 流水类型 | transaction_type | varchar(20) | ✓ | 支付/退款 |
| | 流水状态 | transaction_status | varchar(20) | ✓ | 处理中/成功/失败 |
| **金额信息** | 交易金额 | transaction_amount | decimal(20,6) | ✓ | 本次交易金额（支付为正数，退款为负数） |
| **渠道信息** | 支付渠道 | payment_channel | varchar(50) | ✓ | 线上支付/钱包支付/电汇支付/信用账户 |
| | 渠道交易号 | channel_transaction_number | varchar(64) | ○ | 支付渠道返回的交易号 |
| | 支付方式 | payment_way | varchar(20) | ○ | 具体的支付方式（参考现有表结构） |
| **关联信息** | 原流水号 | original_transaction_id | varchar(32) | ○ | 退款时关联的原支付流水号 |
| | 业务单号 | business_order_id | varchar(32) | ○ | 订单系统的业务单号（如退款单号） |
| **时间信息** | 创建时间 | create_time | datetime | ✓ | 流水记录创建时间 |
| | 完成时间 | complete_date_time | datetime | ○ | 交易完成时间 |
| | 过期时间 | expiration_time | datetime | ○ | 支付过期时间 |
| **系统字段** | 删除状态 | del_flag | int | ○ | 删除标识（0-正常，1-删除） |
| | 创建人 | create_by | varchar(32) | ○ | 创建人ID |
| | 创建人姓名 | create_by_name | varchar(32) | ○ | 创建人姓名 |
| | 更新人 | update_by | varchar(32) | ○ | 更新人ID |
| | 更新人姓名 | update_by_name | varchar(32) | ○ | 更新人姓名 |
| | 更新时间 | update_time | datetime | ○ | 最后更新时间 |
| **扩展信息** | 业务备注 | business_remark | varchar(500) | ○ | 交易备注信息 |

#### 4.4.3 数据库表结构设计

**支付单表（Payment Table）**：
```sql
CREATE TABLE cms_payment
(
    id                      varchar(32) NOT NULL COMMENT '支付单号，主键',
    order_id                varchar(32) NOT NULL COMMENT '关联订单号',
    reseller_id             varchar(32) NOT NULL COMMENT '经销商ID',
    payment_amount          decimal(20, 6) NOT NULL COMMENT '支付金额',
    paid_amount             decimal(20, 6) NOT NULL DEFAULT 0.000000 COMMENT '已支付金额',
    refunded_amount         decimal(20, 6) NOT NULL DEFAULT 0.000000 COMMENT '已退款金额',
    actual_amount           decimal(20, 6) NOT NULL DEFAULT 0.000000 COMMENT '实际收款金额',
    currency                varchar(3) NOT NULL DEFAULT 'CNY' COMMENT '币种',
    payment_type            varchar(20) NOT NULL COMMENT '支付类型（预付款/尾款/其他费用/信用还款）',
    payment_status          varchar(20) NOT NULL COMMENT '支付状态',
    refund_status           varchar(20) NOT NULL DEFAULT '未退款' COMMENT '退款状态',
    business_desc           varchar(500) NULL COMMENT '业务描述',
    payment_deadline        datetime NULL COMMENT '支付截止时间',
    priority_level          int NULL COMMENT '优先级（1-高，2-中，3-低）',
    related_business_id     varchar(32) NULL COMMENT '关联业务ID',
    related_business_type   varchar(20) NULL COMMENT '关联业务类型',
    business_expire_date    datetime NULL COMMENT '业务到期日',
    business_tags           json NULL COMMENT '业务标签',
    del_flag                int NULL DEFAULT 0 COMMENT '删除状态（0-正常，1-删除）',
    create_by               varchar(32) NULL COMMENT '创建人',
    create_by_name          varchar(32) NULL COMMENT '创建人姓名',
    create_time             datetime NULL COMMENT '创建时间',
    update_by               varchar(32) NULL COMMENT '更新人',
    update_by_name          varchar(32) NULL COMMENT '更新人姓名',
    update_time             datetime NULL COMMENT '更新时间',
    PRIMARY KEY (id)
) COMMENT '支付单表' ROW_FORMAT = DYNAMIC;

-- 支付单表索引
CREATE INDEX idx_order_id ON cms_payment (order_id);
CREATE INDEX idx_reseller_id ON cms_payment (reseller_id);
CREATE INDEX idx_payment_status ON cms_payment (payment_status);
CREATE INDEX idx_payment_type ON cms_payment (payment_type);
CREATE INDEX idx_related_business ON cms_payment (related_business_type, related_business_id);
CREATE INDEX idx_create_time ON cms_payment (create_time);
```

**支付流水表（Payment Transaction Table）**：
```sql
CREATE TABLE cms_payment_transaction
(
    id                          varchar(32) NOT NULL COMMENT '流水号，主键',
    payment_id                  varchar(32) NOT NULL COMMENT '支付单号',
    transaction_type            varchar(20) NOT NULL COMMENT '流水类型（支付/退款）',
    transaction_status          varchar(20) NOT NULL COMMENT '流水状态',
    transaction_amount          decimal(20, 6) NOT NULL COMMENT '交易金额',
    payment_channel             varchar(50) NOT NULL COMMENT '支付渠道',
    channel_transaction_number  varchar(64) NULL COMMENT '渠道交易号',
    payment_way                 varchar(20) NULL COMMENT '支付方式',
    original_transaction_id     varchar(32) NULL COMMENT '原流水号（退款时使用）',
    business_order_id           varchar(32) NULL COMMENT '业务单号',
    create_time                 datetime NOT NULL COMMENT '创建时间',
    complete_date_time          datetime NULL COMMENT '完成时间',
    expiration_time             datetime NULL COMMENT '过期时间',
    business_remark             varchar(500) NULL COMMENT '业务备注',
    del_flag                    int NULL DEFAULT 0 COMMENT '删除状态（0-正常，1-删除）',
    create_by                   varchar(32) NULL COMMENT '创建人',
    create_by_name              varchar(32) NULL COMMENT '创建人姓名',
    update_by                   varchar(32) NULL COMMENT '更新人',
    update_by_name              varchar(32) NULL COMMENT '更新人姓名',
    update_time                 datetime NULL COMMENT '更新时间',
    PRIMARY KEY (id)
) COMMENT '支付流水表' ROW_FORMAT = DYNAMIC;

-- 支付流水表索引
CREATE INDEX idx_payment_id ON cms_payment_transaction (payment_id);
CREATE INDEX idx_transaction_type ON cms_payment_transaction (transaction_type);
CREATE INDEX idx_transaction_status ON cms_payment_transaction (transaction_status);
CREATE INDEX idx_channel_transaction_number ON cms_payment_transaction (channel_transaction_number);
CREATE INDEX idx_original_transaction_id ON cms_payment_transaction (original_transaction_id);
CREATE INDEX idx_create_time ON cms_payment_transaction (create_time);
```




### 4.5 支付渠道集成
支付渠道在代码中写死，根据不同渠道生成对应的支付请求，支持B2B大额支付场景：
- **线上支付**：对接银联、企业网银、支付宝企业版、微信企业付款等
- **钱包支付**：调用企业内部资金账户支付接口
- **电汇支付**：生成银行转账信息和转账凭证上传接口，提供凭证确认流程
- **信用账户**：生成赊账记录和还款计划

**注意**：支付渠道的各种响应信息将分别存放在各自的支付渠道服务中，而不在统一的支付流水表中存储。
### 4.6 支付回调处理
考虑B2B大额支付和部分支付的特殊性：
- 接收支付渠道的回调，校验签名和数据完整性
- 支持长时间等待回调（大额支付确认时间较长）
- 根据回调结果更新支付单状态和金额：
  - 更新已支付金额和待支付金额
  - 根据待支付金额是否为0决定是否完全支付
- 对于合并支付，同步更新所有相关支付单状态
- 支付结果通知：
  - 支付单状态变更后通知订单系统
  - 包含支付进度信息（已支付/总金额）
  - 提供支付状态变更的实时通知
### 4.7 支付结果查询

#### 4.7.1 查询方式

**单条查询**：
| 查询条件 | 支持类型 | 说明 |
|----------|----------|------|
| 支付单号 | 精确查询 | 通过唯一支付单号查询 |
| 订单号 | 关联查询 | 查询订单相关的所有支付单 |
| 交易号 | 渠道查询 | 通过支付渠道交易号查询 |
| 经销商ID | 批量查询 | 查询绋销商的所有支付单 |

**条件筛选**：
- **支付状态**：未支付、部分支付、已支付、部分退款、全额退款、失败等
- **支付类型**：预付款、尾款、其他费用
- **时间范围**：创建时间、支付时间、更新时间
- **金额范围**：支付金额区间筛选
- **支付渠道**：按使用的支付渠道筛选

#### 4.7.2 查询结果展示

**支付单基础信息**：
- 支付单详细信息（总金额、已支付金额、已退款金额、实际收款金额、状态、时间等）
- 支付进度（已支付/总金额）
- 退款进度（已退款/已支付）
- 关联订单和经销商信息

**操作历史记录**：
- 支付操作历史记录
- 退款操作历史记录
- 状态变更时间线
- 支付渠道使用记录

**合并支付查询展示**：
- 支付单级别信息：
  * 每个支付单的总金额、已支付金额和待支付金额
  * 当前支付状态和支付进度
  * 支付单相关的订单信息
- 支付流水级别信息：
  * 支付渠道和渠道交易号
  * 每个支付单在本次支付中的分配金额
  * 支付时间和支付状态
- 合并支付汇总信息：
  * 通过渠道交易号关联的所有支付流水
  * 合并支付的总金额（所有关联流水金额之和）
  * 支付渠道的整体支付状态

#### 4.7.3 补偿查询机制

**主动查询触发**：
- 回调超时自动触发
- 用户手动刷新状态
- 定时任务批量检查

**批量操作支持**：
- 批量状态查询
- 查询结果导出
- 批量状态更新


### 4.8 退款管理

#### 4.8.1 退款职责分工

| 系统模块 | 职责范围 | 具体功能 |
|----------|----------|----------|
| **订单系统** | 退款审批管理 | 退款申请、业务审批、退款原因审核 |
| **支付模块** | 退款执行处理 | 接收退款指令、选择支付流水、执行退款操作 |
| **财务系统** | 退款财务处理 | 退款记账、财务对账、资金监控 |

#### 4.8.2 退款接口设计

**接收订单系统退款指令**：
- **接口名称**：`executeRefund`
- **请求参数**：

| 参数名称 | 数据类型 | 必填 | 说明 |
|----------|----------|------|------|
| refundOrderId | String | ✓ | 订单系统的退款单号 |
| paymentId | String | ✓ | 原支付单号 |
| refundAmount | Decimal | ✓ | 退款金额 |
| refundReason | String | ✓ | 退款原因（由订单系统审批确定） |
| approvalInfo | JSON | ✓ | 订单系统的审批信息 |
| refundType | Enum | ✓ | 退款类型（全额/部分） |

#### 4.8.3 支付流水选择机制

**流水选择规则**：
1. **查询原支付单的支付流水记录**
   - 根据支付单号查找所有成功的支付流水
   - 按支付时间倒序排列
   - 显示每条流水的支付渠道、金额、状态信息

2. **支持的流水选择方式**：

| 选择方式 | 适用场景 | 处理逻辑 |
|----------|----------|----------|
| **指定流水退款** | 明确知道要退款的具体支付记录 | 直接使用指定的支付流水进行退款 |
| **最新流水退款** | 一般情况下的退款处理 | 选择最近的一笔支付流水进行退款 |
| **多流水分摊退款** | 退款金额需要跨多笔支付处理 | 按支付金额比例分摊到多个流水 |

3. **流水选择验证**：
   - 验证选择的流水是否支持退款
   - 检查退款金额是否超过原支付金额
   - 确认支付渠道是否支持退款操作

#### 4.8.4 退款执行流程

**退款处理步骤**：
```
接收退款指令 → 验证支付单状态 → 选择支付流水 → 调用渠道退款接口 → 更新支付单状态和金额 → 记录退款流水 → 通知相关系统
```

**具体执行逻辑**：
1. **参数验证**：验证退款指令的完整性和合法性
2. **流水查找**：根据支付单号查找可用的支付流水记录
3. **流水选择**：按照配置的选择策略确定退款流水
4. **渠道调用**：调用对应支付渠道的退款接口
5. **支付单更新**：
   - 更新支付单的已退款金额
   - 重新计算实际收款金额
   - 根据退款情况更新支付单状态（部分退款/全额退款）
6. **退款记录**：创建退款流水记录，关联到支付单
7. **结果通知**：向订单系统和财务系统发送退款结果

#### 4.8.5 退款记录管理

**退款流水记录**：
退款记录直接存储在支付流水表中，通过以下方式区分和管理：

1. **退款流水创建**：
   - 流水类型设置为"退款"
   - 交易金额为负数（表示资金流出）
   - 原流水号关联到被退款的支付流水
   - 业务单号记录订单系统的退款单号

2. **退款与支付关联**：
   - 通过原流水号字段建立退款与支付的关联关系
   - 支持一笔支付对应多笔退款的场景
   - 便于查询和统计某笔支付的退款情况

**支付单退款信息更新**：
- 每次退款成功后，累加支付单的已退款金额
- 重新计算支付单的实际收款金额（已支付金额 - 已退款金额）
- 根据退款比例更新支付单状态：
  - 部分退款：已退款金额 > 0 且 < 已支付金额
  - 全额退款：已退款金额 = 已支付金额

**退款数据统计**：
- 通过流水类型和原流水号可快速统计退款情况
- 支持按支付单、订单、时间等维度进行退款分析
- 简化了数据库表结构，减少了数据维护复杂度

#### 4.8.6 异常处理机制

**退款失败处理**：
- 记录详细的失败原因和错误信息
- 支持退款重试机制（针对临时性失败）
- 向订单系统反馈退款失败结果
- 提供人工干预和处理通道
### 4.9 对账管理
针对B2B大额支付的对账要求：
- 每日定时与各支付渠道对账，校验交易一致性
- 处理多渠道分次支付的对账复杂性
- 合并支付单的对账和金额分配验证
- 生成详细对账报表，包括：
  - 预付款/尾款分类统计
  - 各支付渠道的交易汇总
  - 异常交易和差异分析
- 发现差异时的处理流程：
  - 自动补偿处理
  - 人工审核确认
  - 业务系统状态同步
### 4.10 异常处理与重试机制
考虑B2B大额支付的稳定性要求：
- 回调失败时自动重试机制（考虑大额支付确认时间长）
- 网络故障时支持支付状态补偿查询
- 与订单系统通信异常的处理流程
- 支付通知失败的重试和补偿机制
- 多渠道支付异常的协调处理
- 合并支付异常时的回滚机制
- 长时间未支付的订单提醒和处理
- 支付超时的自动处理规则

### 4.11 信用还款处理

#### 4.11.1 信用还款处理原则

**统一处理原则**：
信用还款操作本质上就是一种特定类型的支付操作，不需要特殊的处理流程。

- **支付类型标识**：信用还款只是支付类型为"信用还款"的普通支付单
- **处理流程统一**：完全按照标准支付单流程处理，无需特殊逻辑
- **支付渠道支持**：支持所有标准支付渠道（线上支付、钱包支付、电汇支付等）
- **批量操作支持**：可与其他类型支付单一起进行合并支付

#### 4.11.2 信用还款支付单创建

**接收信用管理系统还款指令**：
支付模块接收来自信用管理系统的还款支付单创建请求，按标准支付单创建流程处理。

| 参数名称 | 数据类型 | 必填 | 说明 |
|----------|----------|------|------|
| 关联业务ID | String(32) | ✓ | 关联的信用记录ID |
| 关联业务类型 | String(20) | ✓ | 固定为CREDIT_RECORD |
| 经销商ID | String(32) | ✓ | 还款方经销商标识 |
| 还款金额 | Decimal(15,2) | ✓ | 本次还款金额 |
| 还款到期日 | DateTime | ✓ | 还款截止日期 |
| 业务描述 | String(500) | ○ | 还款说明信息 |

**创建后的支付单特征**：
- 支付类型：信用还款
- 处理方式：与预付款、尾款、其他费用支付单完全相同
- 支持功能：部分支付、合并支付、分批支付等所有标准功能

#### 4.11.3 信用还款执行

**执行流程**：
信用还款支付单的执行完全遵循第4.2节的统一支付执行流程，无任何特殊处理：

1. **支付单选择**：信用还款支付单可与其他类型支付单一起选择
2. **合并支付**：可与预付款、尾款等支付单合并支付
3. **支付渠道**：支持所有标准支付渠道
4. **状态管理**：采用统一的支付状态和退款状态管理
5. **结果通知**：按标准流程通知信用管理系统

#### 4.11.4 信用还款查询

**查询方式**：
信用还款支付单的查询完全遵循第4.7节的统一查询机制：

- 通过支付类型="信用还款"进行筛选
- 通过关联业务ID查询特定信用记录的还款情况
- 支持所有标准查询条件（状态、时间、金额等）
- 查询结果展示与其他支付单完全一致

### 4.12 监控与报表
- 实时监控支付单的执行情况和状态变化
- 按支付单类型（预付款、尾款、其他费用、信用还款等）统一统计和分析
- 支付渠道使用情况和效率统计
- 合并支付和批量支付的使用分析
- 大额支付风险监控和预警
- 生成业务分析报表：
  - 支付单完成率和及时性分析
  - 客户支付行为和偏好分析
  - 支付渠道效率和成本对比
  - 支付单状态分布统计
  - 各类型支付单（包括信用还款）的统一统计和趋势分析



### 4.12 系统集成接口

#### 4.12.1 与订单系统的集成接口

| 接口名称 | 接口类型 | 功能说明 |
|----------|----------|----------|
| 支付单创建接口 | 接收 | 接收订单系统创建的支付单请求 |
| 支付结果通知接口 | 发送 | 通知订单系统支付处理结果 |
| 支付单状态查询接口 | 提供 | 供订单系统查询支付单状态 |
| 支付单信息更新接口 | 接收 | 接收订单系统的支付单修改请求 |
| **退款执行接口** | 接收 | 接收订单系统审批后的退款执行指令 |
| **退款结果通知接口** | 发送 | 通知订单系统退款处理结果和状态 |
| **支付流水查询接口** | 提供 | 供订单系统查询支付流水记录（用于退款选择） |

#### 4.12.2 与财务系统的集成接口

| 接口名称 | 接口类型 | 功能说明 |
|----------|----------|----------|
| 支付流水同步接口 | 发送 | 向财务系统同步支付流水数据 |
| 对账数据接口 | 提供 | 提供日常对账所需的数据 |
| **退款流水同步接口** | 发送 | 向财务系统同步退款流水和记账信息 |
| **退款对账接口** | 提供 | 提供退款相关的对账数据 |

#### 4.12.3 与信用管理系统的集成接口

| 接口名称 | 接口类型 | 功能说明 |
|----------|----------|----------|
| 信用还款支付单创建接口 | 接收 | 接收信用管理系统创建的还款支付单请求 |
| 还款结果通知接口 | 发送 | 通知信用管理系统还款处理结果和状态 |
| 还款支付单查询接口 | 提供 | 供信用管理系统查询还款支付单状态和历史 |

#### 4.12.4 外部支付渠道接口

| 接口分类 | 具体接口 | 功能说明 |
|----------|----------|----------|
| 第三方支付 | 银联支付接口 | 对接银联等第三方支付平台 |
| | 企业网银接口 | 对接各大银行企业网银 |
| 内部支付 | 企业账户接口 | 调用企业内部资金账户 |
| | 信用赊账接口 | 处理企业信用额度支付 |


## 5. 非功能需求

### 5.1 性能要求

| 性能指标 | 要求 | 说明 |
|----------|------|------|
| **响应时间** | < 3秒 | 支付请求处理响应时间 |
| **并发处理** | 1000 TPS | 支持的并发交易处理能力 |
| **可用性** | 99.9% | 系统年度可用性要求 |
| **数据一致性** | 强一致性 | 支付数据必须保证强一致性 |

### 5.2 安全要求

| 安全类别 | 具体要求 |
|----------|----------|
| **数据加密** | 敏感数据传输和存储必须加密 |
| **访问控制** | 基于角色的访问权限控制 |
| **审计日志** | 完整记录所有支付操作日志 |
| **合规性** | 符合金融支付相关法规要求 |

### 5.3 可扩展性要求

- **水平扩展**：支持多实例部署和负载均衡
- **支付渠道扩展**：支持新增支付渠道的快速接入
- **业务规则扩展**：支持灵活的支付规则配置

## 6. 约束条件

### 6.1 技术约束

- 必须与现有订单系统保持兼容
- 需要遵循企业现有的技术架构规范
- 支付渠道接口需要满足各渠道的技术要求

### 6.2 业务约束

- 大额支付需要经过审批流程
- 支付操作必须有完整的审计记录
- 退款操作需要相应的业务授权

### 6.3 合规约束

- 必须符合国家金融监管要求
- 支付数据处理需要满足数据保护法规
- 跨境支付需要符合外汇管理规定

## 7. 附录

### 7.1 参考文档

- 订单系统需求文档
- 企业技术架构规范
- 支付行业标准规范

### 7.2 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| v1.0 | 2025-09-26 | 初始版本创建 | 产品团队 |
| v1.1 | 2025-09-26 | 基于现有数据库表结构添加数据库字段名称映射，完善表结构设计 | 数据库设计专家 |
| v1.2 | 2025-09-26 | 根据业务需求优化：去掉支付渠道配置表，去掉审计日志表，企业用户ID改为经销商ID，简化支付流水表信息 | 需求分析专家 |
| v1.3 | 2025-09-26 | 简化表命名：去掉order字段，cms_payment_order改为cms_payment，相关外键字段payment_order_id改为payment_id | 需求分析专家 |
| v1.4 | 2025-09-27 | 重要架构简化：1）统一支付处理流程，单支付单作为多支付单合并支付的特例；2）简化信用还款处理，作为支付类型为"信用还款"的普通支付操作 | 需求分析师 |

### 7.3 数据库设计更新说明

#### 7.3.1 本次更新内容

本次更新基于现有系统数据库表结构（`cms_order_pay`、`cms_order_pay_detail`）的命名风格，为支付模块需求设计添加了完整的数据库字段名称映射：

**更新内容包括**：
1. **数据库字段名称映射**：为所有业务字段提供对应的数据库字段名称
2. **命名规范分析**：总结现有系统的字段命名特点和规律
3. **完整表结构设计**：提供完整的建表语句和索引设计
4. **系统字段补充**：添加与现有系统一致的系统管理字段

**设计原则**：
- 严格参考现有表结构的命名风格和数据类型定义
- 保持业务需求不变，仅增加数据库层面的技术实现
- 移除原系统中已拆分到其他模块的字段（如物流相关字段）
- 新增支持业务扩展的字段（如关联业务、信用支付等）

#### 7.3.2 表结构对照

| 新表名称 | 参考原表 | 设计说明 |
|----------|----------|----------|
| `cms_payment` | `cms_order_pay` | 支付单主表，保持命名风格一致 |
| `cms_payment_transaction` | `cms_order_pay_detail` | 支付流水表，整合支付和退款记录 |


#### 7.3.3 字段命名对照示例

| 业务概念 | 现有系统字段 | 新系统字段 | 说明 |
|----------|-------------|------------|------|
| 订单关联 | `order_id` | `order_id` | 保持一致 |
| 支付金额 | `total_pay_amount` | `payment_amount` | 简化命名 |
| 交易状态 | `status` | `payment_status` | 明确业务含义 |
| 创建时间 | `create_time` | `create_time` | 保持一致 |
| 删除标识 | `del_flag` | `del_flag` | 保持一致 |

### 7.4 待确认事项

- [ ] 支付渠道的具体技术对接方案
- [ ] 与财务系统的详细集成方案  
- [ ] 大额支付的审批流程细节
- [ ] 异常情况的处理策略
- [ ] 数据库表结构的最终技术审核