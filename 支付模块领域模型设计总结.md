# 支付模块领域模型设计总结

## 设计概述

基于支付模块需求设### 3. 核心值对象设计

#### BigDecimal（金额处理）
- **特性**：直接使用BigDecimal类型处理金额，精度统一为6位小数
- **币种**：系统固定使用人民币（CNY），简化货币处理逻辑
- **计算**：标准BigDecimal运算，避免复杂的货币转换

#### PaymentChannel（支付渠道值对象）
- **特性**：封装渠道信息和业务规则，专注单笔支付处理
- **预定义渠道**：线上支付、钱包支付、电汇支付、信用账户
- **设计简化**：移除批量支付支持，因为从渠道角度看合并支付就是单笔支付新设计了完整的支付模块领域模型，采用DDD（领域驱动设计）架构，支持企业间特种设备定制交易的复杂支付场景。

## 核心设计成果

### 1. 聚合根设计

#### Payment（支付单聚合根）
- **职责**：管理支付单的完整生命周期，包括创建、支付执行、退款处理、状态管理
- **核心特性**：
  - 支持单支付单和合并支付的统一处理流程
  - 集成支付和退款流水的统一管理
  - 完整的金额计算和状态转换机制
  - 支持信用还款等特殊业务场景

#### PaymentBatch（批量支付聚合根）  
- **职责**：专门处理多支付单合并支付的复杂场景
- **核心特性**：
  - 支付分配算法和金额分摊机制
  - 批量支付状态管理和结果处理
  - 支持部分成功的复杂场景处理

### 2. 核心实体设计

#### PaymentTransaction（支付流水实体）
- **设计亮点**：统一管理支付和退款流水，通过transactionType区分操作类型
- **核心特性**：
  - 完整的交易生命周期管理
  - 渠道交易信息的统一存储
  - 支持退款与原支付的关联追踪

### 3. 值对象设计

#### Money（金额值对象）
- **特性**：不可变设计，丰富的业务计算方法，严格的验证规则
- **方法**：加减乘除运算、比较操作、格式化显示

#### PaymentChannel（支付渠道值对象）
- **特性**：封装渠道信息和业务规则，支持渠道能力验证
- **预定义渠道**：线上支付、钱包支付、电汇支付、信用账户

#### RelatedBusinessInfo（关联业务信息值对象）
- **特性**：支持多种业务场景的关联信息管理
- **支持场景**：信用还款、提货单、附加服务等

### 4. 领域服务设计

#### PaymentExecutionService（支付执行服务）
- **职责**：协调支付执行的复杂业务逻辑
- **核心方法**：
  - `executeSinglePayment()` - 单支付单支付执行
  - `executeBatchPayment()` - 批量支付执行  
  - `processPaymentCallback()` - 支付回调处理

#### PaymentValidationService（支付验证服务）
- **职责**：封装复杂的支付业务规则验证
- **核心验证**：支付执行验证、批量支付验证、退款验证、信用还款验证

#### PaymentAmountCalculationService（金额计算服务）
- **职责**：处理复杂的金额分配和计算逻辑
- **核心算法**：比例分配、优先级分配、退款分配等

## 核心业务能力

### 1. 统一支付处理
- **设计理念**：单支付单支付作为多支付单合并支付的特例，使用统一处理流程
- **优势**：简化系统复杂度，减少代码冗余，统一数据流和状态管理

### 2. 完整的状态管理
- **支付状态**：未支付→支付中→部分支付→已支付，支持失败和停止状态
- **退款状态**：未退款→退款中→部分退款→全额退款，支持退款失败处理
- **状态转换**：严格的状态机规则，确保业务一致性

### 3. 简化的金额处理
- **金额类型**：支付金额、已支付金额、已退款金额、实际收款金额、待支付金额（统一使用BigDecimal）
- **计算规则**：实际收款金额 = 已支付金额 - 已退款金额
- **币种固定**：系统固定使用人民币（CNY），精度统一为6位小数
- **验证约束**：简化的金额一致性约束和业务规则验证

### 4. 多场景业务支持
- **支付类型**：预付款、尾款、其他费用、信用还款
- **支付渠道**：线上支付、钱包支付、电汇支付、信用账户
- **特殊业务**：信用还款按普通支付流程处理，通过业务标识区分

## 设计原则体现

### 1. DDD架构原则
- **聚合设计**：清晰的聚合边界，确保事务一致性
- **值对象使用**：不可变设计，丰富的业务行为
- **领域服务**：封装跨聚合的复杂业务逻辑
- **领域事件**：支持松耦合的系统集成

### 2. 业务规则封装
- **聚合内不变式**：金额一致性、状态转换等核心规则在聚合内强制执行
- **业务验证**：通过领域服务提供全面的业务规则验证
- **异常处理**：完整的业务异常定义和处理机制

### 3. 扩展性设计
- **关联业务支持**：通过RelatedBusinessInfo支持未来业务扩展
- **渠道适配**：统一的渠道接口，支持新渠道接入
- **配置驱动**：支付渠道配置化，业务规则可配置

## 技术实现指导

### 1. 数据库设计
- **支付单表**：`cms_payment` - 存储支付单核心信息
- **支付流水表**：`cms_payment_transaction` - 统一存储支付和退款流水
- **索引策略**：基于查询场景设计的完整索引方案

### 2. 代码实现建议
- **充血模型**：聚合根和实体包含丰富的业务逻辑
- **不可变对象**：值对象采用不可变设计
- **事件驱动**：通过领域事件实现系统解耦

### 3. 集成设计
- **订单系统集成**：通过领域事件同步支付状态
- **信用管理集成**：支持信用还款和额度管理
- **支付渠道集成**：统一的适配器模式

## 关键创新点

### 1. 统一流水设计
将支付和退款流水统一管理，通过transactionType区分，简化了数据模型复杂度，提高了查询效率。

### 2. 合并支付架构
单支付单支付作为合并支付的特例，统一处理逻辑，支持灵活的支付组合和金额分配。

### 3. 业务关联机制
通过RelatedBusinessInfo值对象，灵活支持不同业务场景的关联需求，如信用还款、提货费用等。

### 4. 状态机设计
严格的状态转换规则，支持复杂的支付和退款状态管理，确保业务一致性。

### 5. 金额处理简化
- **去复杂化设计**：直接使用BigDecimal替代Money值对象，减少系统复杂度
- **币种统一**：固定使用人民币，避免货币转换的复杂性
- **渠道简化**：从渠道角度看，合并支付就是单笔支付，简化渠道设计

## 后续工作建议

1. **应用层设计**：基于领域模型设计应用服务和用例编排
2. **基础设施层实现**：Repository实现和外部系统集成
3. **测试策略**：领域模型单元测试和集成测试
4. **性能优化**：基于实际业务量进行性能调优

---

**设计总结**: ✅ 已完成
**文档版本**: v1.0  
**完成时间**: 2025年9月28日
**设计基准**: 支付模块需求设计文档 v1.4
**架构原则**: DDD领域驱动设计