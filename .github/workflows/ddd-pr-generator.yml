name: DDD Code Generator & PR Creator
on:
  workflow_dispatch:
    inputs:
      domain_spec:
        description: 'DDD Domain Specification (YAML format supported)'
        required: true
        type: string
      base_package:
        description: 'Base Package Name (e.g., com.example.project)'
        required: true
        default: 'com.example.project'
      branch_name:
        description: 'Feature Branch Name'
        required: true
        default: 'feature/ddd-domain'
      generate_tests:
        description: 'Generate test files'
        required: false
        type: boolean
        default: true
      validate_code:
        description: 'Run code validation'
        required: false
        type: boolean
        default: true
      update_docs:
        description: 'Update documentation'
        required: false
        type: boolean
        default: true

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  generate-ddd-code:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'
          
      - name: ğŸŒ¿ Create Feature Branch
        run: |
          git config --global user.name 'GitHub Copilot Agent'
          git config --global user.email 'copilot@github.com'
          git checkout -b ${{ github.event.inputs.branch_name }}
          
      - name: ğŸ—ï¸ Generate DDD Code Structure
        uses: github/copilot-cli@v1
        with:
          prompt: |
            åŸºäºä»¥ä¸‹ DDD è§„èŒƒç”Ÿæˆå®Œæ•´çš„ Spring Boot é¡¹ç›®ä»£ç ï¼š
            
            é¡¹ç›®æ ¹åŒ…ï¼š${{ github.event.inputs.base_package }}
            ç”Ÿæˆæµ‹è¯•ï¼š${{ github.event.inputs.generate_tests }}
            
            é¢†åŸŸè§„èŒƒï¼š
            ${{ github.event.inputs.domain_spec }}
            
            è¯·ä¸¥æ ¼æŒ‰ç…§ .github/prompts/ddd-code.prompts.md ä¸­çš„è§„èŒƒç”Ÿæˆä»£ç ã€‚
            ç¡®ä¿ç”Ÿæˆçš„ä»£ç ï¼š
            1. å®Œæ•´å¯ç¼–è¯‘
            2. ç¬¦åˆDDDåˆ†å±‚æ¶æ„
            3. åŒ…å«å¿…è¦çš„æ³¨è§£å’Œé…ç½®
            4. éµå¾ªå‘½åè§„èŒƒ
            
      - name: ğŸ§ª Generate Test Files
        if: ${{ github.event.inputs.generate_tests == 'true' }}
        uses: github/copilot-cli@v1
        with:
          prompt: |
            ä¸ºå·²ç”Ÿæˆçš„DDDä»£ç åˆ›å»ºå®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼ŒåŒ…æ‹¬ï¼š
            1. å•å…ƒæµ‹è¯• (é¢†åŸŸå±‚ã€åº”ç”¨å±‚)
            2. é›†æˆæµ‹è¯• (Repositoryå±‚)
            3. APIæµ‹è¯• (Controllerå±‚)
            
            è¯·å‚è€ƒ .github/prompts/ddd-test-generator.prompt.md ä¸­çš„æµ‹è¯•è§„èŒƒã€‚
            
      - name: ğŸ“‹ Validate Code Quality
        if: ${{ github.event.inputs.validate_code == 'true' }}
        uses: github/copilot-cli@v1
        with:
          prompt: |
            éªŒè¯ç”Ÿæˆçš„DDDä»£ç è´¨é‡ï¼Œæ£€æŸ¥ï¼š
            1. æ¶æ„åˆ†å±‚æ˜¯å¦æ­£ç¡®
            2. å‘½åè§„èŒƒæ˜¯å¦ç¬¦åˆè¦æ±‚
            3. ä¸šåŠ¡é€»è¾‘æ˜¯å¦æ­£ç¡®å°è£…
            4. ä»£ç æ˜¯å¦å¯ç¼–è¯‘
            
            å‚è€ƒ .github/prompts/ddd-validation.prompt.md è¿›è¡ŒéªŒè¯ã€‚
            
      - name: ğŸ”¨ Compile and Test
        run: |
          if [ -f "pom.xml" ]; then
            echo "ğŸ” Detected Maven project"
            mvn clean compile -B -V
            if [ "${{ github.event.inputs.generate_tests }}" == "true" ]; then
              mvn test -B
            fi
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "ğŸ” Detected Gradle project"
            chmod +x gradlew
            ./gradlew build -x test --no-daemon
            if [ "${{ github.event.inputs.generate_tests }}" == "true" ]; then
              ./gradlew test --no-daemon
            fi
          else
            echo "âš ï¸ No Maven or Gradle build file found"
          fi
          
      - name: ğŸ“Š Generate Code Quality Report
        run: |
          echo "## ğŸ“Š ä»£ç è´¨é‡æŠ¥å‘Š" > code_quality_report.md
          echo "" >> code_quality_report.md
          echo "### ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ç»Ÿè®¡" >> code_quality_report.md
          
          # ç»Ÿè®¡ç”Ÿæˆçš„æ–‡ä»¶
          java_files=$(find src -name "*.java" | wc -l)
          test_files=$(find src/test -name "*Test.java" 2>/dev/null | wc -l || echo "0")
          xml_files=$(find src -name "*.xml" | wc -l)
          yaml_files=$(find src -name "*.yml" -o -name "*.yaml" | wc -l)
          
          echo "- Javaæºæ–‡ä»¶: $java_files" >> code_quality_report.md
          echo "- æµ‹è¯•æ–‡ä»¶: $test_files" >> code_quality_report.md
          echo "- XMLé…ç½®æ–‡ä»¶: $xml_files" >> code_quality_report.md
          echo "- YAMLé…ç½®æ–‡ä»¶: $yaml_files" >> code_quality_report.md
          echo "" >> code_quality_report.md
          
          # æ£€æŸ¥TODOæ ‡è®°
          echo "### ğŸ” å¾…å®Œæˆé¡¹ (TODO)" >> code_quality_report.md
          todo_count=$(grep -r "TODO" src --include="*.java" | wc -l || echo "0")
          echo "- å‘ç° $todo_count ä¸ª TODO æ ‡è®°" >> code_quality_report.md
          
          if [ $todo_count -gt 0 ]; then
            echo "" >> code_quality_report.md
            echo "#### TODO è¯¦æƒ…:" >> code_quality_report.md
            grep -r "TODO" src --include="*.java" -n | head -10 | while read line; do
              echo "- \`$line\`" >> code_quality_report.md
            done
          fi
          
          echo "" >> code_quality_report.md
          echo "### âœ… ä»£ç è´¨é‡æ£€æŸ¥" >> code_quality_report.md
          echo "- [x] ä»£ç å¯ç¼–è¯‘" >> code_quality_report.md
          echo "- [x] ç¬¦åˆDDDåˆ†å±‚æ¶æ„" >> code_quality_report.md
          echo "- [x] åŒ…å«å¿…è¦æ³¨è§£" >> code_quality_report.md
          if [ "${{ github.event.inputs.generate_tests }}" == "true" ]; then
            echo "- [x] åŒ…å«æµ‹è¯•ç”¨ä¾‹" >> code_quality_report.md
          fi
          
      - name: ğŸ“š Update Documentation
        if: ${{ github.event.inputs.update_docs == 'true' }}
        run: |
          # ç”ŸæˆAPIæ–‡æ¡£
          if [ -f "pom.xml" ]; then
            mvn javadoc:javadoc -B -q || echo "âš ï¸ Javadoc generation failed"
          fi
          
          # æ›´æ–°README
          if [ ! -f "README.md" ]; then
            echo "# ${{ github.event.inputs.base_package }}" > README.md
            echo "" >> README.md
            echo "DDDæ¶æ„çš„Spring Booté¡¹ç›®ï¼Œç”±GitHub Copilotè‡ªåŠ¨ç”Ÿæˆã€‚" >> README.md
            echo "" >> README.md
            echo "## é¡¹ç›®ç»“æ„" >> README.md
            echo "" >> README.md
            echo "\`\`\`" >> README.md
            find src -type f -name "*.java" | head -20 | sed 's/^/- /' >> README.md
            echo "\`\`\`" >> README.md
            echo "" >> README.md
            echo "## å¿«é€Ÿå¼€å§‹" >> README.md
            echo "" >> README.md
            echo "1. é…ç½®æ•°æ®åº“è¿æ¥" >> README.md
            echo "2. è¿è¡Œ \`mvn spring-boot:run\`" >> README.md
            echo "3. è®¿é—® http://localhost:8080" >> README.md
          fi
          
      - name: ğŸ“„ Prepare PR Description
        run: |
          cp .github/prompts/pr-template.md pr_description.md
          
          # æ›¿æ¢æ¨¡æ¿å˜é‡
          sed -i "s/\[base_package\]/${{ github.event.inputs.base_package }}/g" pr_description.md
          
          # æ·»åŠ ä»£ç è´¨é‡æŠ¥å‘Š
          if [ -f "code_quality_report.md" ]; then
            echo "" >> pr_description.md
            cat code_quality_report.md >> pr_description.md
          fi
          
          # æ·»åŠ æ–‡ä»¶å˜æ›´ç»Ÿè®¡
          echo "" >> pr_description.md
          echo "## ğŸ“ˆ å˜æ›´ç»Ÿè®¡" >> pr_description.md
          echo "" >> pr_description.md
          echo "### æ–°å¢æ–‡ä»¶" >> pr_description.md
          git ls-files --others --exclude-standard | head -10 | sed 's/^/- /' >> pr_description.md
          
      - name: ğŸ’¾ Commit Changes
        run: |
          git add .
          if [ -n "$(git diff --staged)" ]; then
            git commit -m "feat: Add DDD structure for domain
            
            - ç”Ÿæˆå®Œæ•´çš„DDDåˆ†å±‚æ¶æ„ä»£ç 
            - åŒ…å«èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡ã€åº”ç”¨æœåŠ¡
            - æ·»åŠ Repositoryæ¥å£å’Œå®ç°
            - åŒ…å«REST APIå’ŒDTOå¯¹è±¡
            $(if [ '${{ github.event.inputs.generate_tests }}' == 'true' ]; then echo '- ç”Ÿæˆå®Œæ•´æµ‹è¯•å¥—ä»¶'; fi)
            $(if [ '${{ github.event.inputs.validate_code }}' == 'true' ]; then echo '- é€šè¿‡ä»£ç è´¨é‡éªŒè¯'; fi)
            
            Generated by GitHub Copilot DDD Agent ğŸ¤–"
            
            git push origin ${{ github.event.inputs.branch_name }}
          else
            echo "âš ï¸ No changes to commit"
            exit 1
          fi
          
      - name: ğŸ”„ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.event.inputs.branch_name }}
          title: "feat: Add DDD structure for domain - ${{ github.event.inputs.base_package }}"
          body-path: pr_description.md
          labels: |
            enhancement
            ddd
            copilot-generated
            auto-generated
          reviewers: |
            ${{ github.actor }}
          assignees: |
            ${{ github.actor }}
          draft: false
          delete-branch: false
          
      - name: ğŸ“ Summary
        run: |
          echo "## ğŸ‰ DDDä»£ç ç”Ÿæˆå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ç”Ÿæˆç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸºç¡€åŒ…**: ${{ github.event.inputs.base_package }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯å**: ${{ github.event.inputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæµ‹è¯•**: ${{ github.event.inputs.generate_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»£ç éªŒè¯**: ${{ github.event.inputs.validate_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— å¿«é€Ÿé“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [æŸ¥çœ‹åˆ†æ”¯](../../tree/${{ github.event.inputs.branch_name }})" >> $GITHUB_STEP_SUMMARY
          echo "- [åˆ›å»ºçš„PR](../../pulls)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… å®¡æŸ¥ç”Ÿæˆçš„ä»£ç " >> $GITHUB_STEP_SUMMARY
          echo "2. ğŸ§ª è¿è¡Œæµ‹è¯•éªŒè¯åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "3. ğŸ“ å®Œå–„TODOæ ‡è®°çš„åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "4. ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ" >> $GITHUB_STEP_SUMMARY

  notify-completion:
    needs: generate-ddd-code
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¬ Notify Completion
        run: |
          if [ "${{ needs.generate-ddd-code.result }}" == "success" ]; then
            echo "âœ… DDDä»£ç ç”ŸæˆæˆåŠŸå®Œæˆï¼"
            echo "åˆ†æ”¯: ${{ github.event.inputs.branch_name }}"
            echo "åŒ…å: ${{ github.event.inputs.base_package }}"
          else
            echo "âŒ DDDä»£ç ç”Ÿæˆå¤±è´¥"
            echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–æ›´å¤šä¿¡æ¯"
          fi